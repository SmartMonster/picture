<head>
    <meta charset="utf-8">
    <meta name="Keywords" content="极客时间,极客邦,极客邦科技,极客邦控股,极客时间App,专栏订阅,极客新闻,二叉树,极客Live,QCon,左耳听风,AI技术内参,大航海时代,陈皓,徐飞,洪亮劼,霍泰稳,池建强,Selina,Gary,InfoQ,极客搜索">
    <meta name="description" content="极客时间是极客邦科技出品的一款 IT 内容知识服务 App，内容包含专栏订阅、极客新闻、热点专题、直播、视频和音频等多形式的知识内容，并设有陈皓专栏、徐飞专栏、洪亮劼专栏等专栏供订阅。">
    <link rel="apple-touch-icon" sizes="180x180" href="//static001.geekbang.org/static/icon/time/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="//static001.geekbang.org/static/icon/time/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="//static001.geekbang.org/static/icon/time/favicon-16x16.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>01 | 可见性、原子性和有序性问题：并发编程Bug的源头</title>

    <link href="https://static001.geekbang.org/static/time/css/app.3e04e644962ca8c2f97ec7731bb7710c.css" rel="stylesheet">
    <style type="text/css">.hljs-ln {
        border-collapse: collapse
    }

    .hljs-ln td {
        padding: 0
    }

    .hljs-ln-n:before {
        content: attr(data-line-number)
    }</style>
    <style type="text/css">#iv-container {
        position: fixed;
        background: #0d0d0d;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        display: none;
        z-index: 1000
    }

    .iv-container {
        overflow: hidden
    }

    .iv-close {
        width: 26px;
        height: 26px;
        position: absolute;
        right: 20px;
        top: 20px;
        cursor: pointer;
        text-align: center;
        overflow: hidden;
        text-shadow: 0 0 3px #6d6d6d;
        -webkit-transition: all .2s ease;
        -moz-transition: all ease .2s;
        -o-transition: all ease .2s;
        transition: all .2s ease
    }

    .iv-close:after, .iv-close:before {
        content: "";
        height: 2px;
        width: 26px;
        background: #fff;
        position: absolute;
        left: 0;
        top: 50%;
        margin-top: -2px;
        border-radius: 2px
    }

    .iv-close:before {
        -webkit-transform: rotate(45deg);
        -moz-transform: rotate(45deg);
        -ms-transform: rotate(45deg);
        -o-transform: rotate(45deg);
        transform: rotate(45deg)
    }

    .iv-close:after {
        -webkit-transform: rotate(-45deg);
        -moz-transform: rotate(-45deg);
        -ms-transform: rotate(-45deg);
        -o-transform: rotate(-45deg);
        transform: rotate(-45deg)
    }

    .iv-close:hover {
        -webkit-transform: rotate(90deg);
        -moz-transform: rotate(90deg);
        -ms-transform: rotate(90deg);
        -o-transform: rotate(90deg);
        transform: rotate(90deg)
    }

    .iv-image-view {
        position: absolute;
        height: 100%;
        width: 100%
    }

    .iv-image-wrap {
        display: inline-block
    }

    .iv-image-wrap:active {
        cursor: move
    }

    .iv-large-image {
        cursor: move;
        max-width: 100%;
        max-height: 100%;
        background-color: #ececec;
        -moz-transform: translateZ(0);
        -o-transform: translateZ(0)
    }

    .iv-large-image, .iv-loader {
        position: absolute;
        -webkit-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0)
    }

    .iv-loader {
        top: 50%;
        left: 50%;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        z-index: 100;
        margin-top: -16px;
        margin-left: -16px;
        font-size: 5px;
        text-indent: -9999em;
        border-top: 1em solid hsla(0, 0%, 100%, .2);
        border-right: 1em solid hsla(0, 0%, 100%, .2);
        border-bottom: 1em solid hsla(0, 0%, 100%, .2);
        border-left: 1em solid #fff;
        -webkit-animation: load8 1.1s infinite linear;
        animation: load8 1.1s infinite linear
    }

    .iv-loader:after {
        width: 10em;
        height: 10em;
        border-radius: 50%
    }

    @-webkit-keyframes load8 {
        0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg)
        }
        to {
            -webkit-transform: rotate(1turn);
            transform: rotate(1turn)
        }
    }

    @keyframes load8 {
        0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg)
        }
        to {
            -webkit-transform: rotate(1turn);
            transform: rotate(1turn)
        }
    }</style>
    <style type="text/css">.vue-pull-to-wrapper[data-v-12abd9fb] {
        display: -webkit-box;
        display: -webkit-flex;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -webkit-flex-direction: column;
        flex-direction: column;
        height: 100%
    }

    .scroll-container[data-v-12abd9fb] {
        -webkit-box-flex: 1;
        -webkit-flex: 1;
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch
    }

    .vue-pull-to-wrapper .action-block[data-v-12abd9fb] {
        position: relative;
        width: 100%
    }

    .default-text[data-v-12abd9fb] {
        height: 100%;
        line-height: 50px;
        text-align: center
    }</style>
    <style type="text/css">.button-cancel[data-v-87ffcada] {
        color: #888;
        border: 1px solid #888;
        border-radius: 3px;
        margin-right: 12px
    }

    .button-cancel[data-v-87ffcada], .button-primary[data-v-87ffcada] {
        -webkit-box-flex: 1;
        -ms-flex-positive: 1;
        flex-grow: 1;
        height: 35px;
        display: inline-block;
        font-size: 15px;
        text-align: center;
        line-height: 36px
    }

    .button-primary[data-v-87ffcada] {
        color: #fff;
        background-color: #ff5a05;
        border-radius: 3px
    }

    .pd[data-v-87ffcada] {
        padding-left: 1.375rem;
        padding-right: 1.375rem
    }

    .article[data-v-87ffcada] {
        max-width: 46.25rem;
        margin: 0 auto
    }

    .article .article-unavailable[data-v-87ffcada] {
        color: #fa8919;
        font-size: 15px;
        font-weight: 600;
        line-height: 24px;
        border-radius: 5px;
        padding: 12px;
        background-color: #f6f7fb;
        margin-top: 20px
    }

    .article .article-unavailable .iconfont[data-v-87ffcada] {
        font-size: 12px
    }

    .article .main[data-v-87ffcada] {
        padding: 1.25rem 0;
        margin-bottom: 52px
    }

    .article-title[data-v-87ffcada] {
        color: #353535;
        font-weight: 400;
        line-height: 1.65rem;
        font-size: 1.34375rem
    }

    .article-info[data-v-87ffcada] {
        color: #888;
        font-size: .9375rem;
        margin-top: 1.0625rem
    }

    .article-content[data-v-87ffcada] {
        margin-top: 1.0625rem
    }

    .article-content.android video[data-v-87ffcada]::-webkit-media-controls-fullscreen-button {
        display: none
    }

    .copyright[data-v-87ffcada] {
        color: #b2b2b2;
        padding-bottom: 20px;
        margin-top: 20px;
        font-size: 13px
    }

    .audio-player[data-v-87ffcada] {
        width: 100%;
        margin: 20px 0
    }

    .to-comment[data-v-87ffcada] {
        overflow: hidden;
        padding-top: 10px;
        margin-bottom: -30px
    }

    .to-comment a.button-primary[data-v-87ffcada] {
        float: right;
        height: 20px;
        font-size: 12px;
        line-height: 20px;
        padding: 4px 8px;
        cursor: pointer
    }

    .article-comments[data-v-87ffcada] {
        margin-top: 2rem
    }

    .article-comments h2[data-v-87ffcada] {
        text-align: center;
        color: #888;
        position: relative;
        z-index: 1;
        margin-bottom: 1rem
    }

    .article-comments h2[data-v-87ffcada]:before {
        border-top: 1px dotted #888;
        content: "";
        position: absolute;
        top: 56%;
        left: 0;
        width: 100%;
        z-index: -1
    }

    .article-comments h2 span[data-v-87ffcada] {
        font-size: 15.25px;
        font-weight: 400;
        padding: 0 1rem;
        background: #fff;
        display: inline-block
    }

    .article-sub-bottom[data-v-87ffcada] {
        z-index: 10;
        cursor: pointer
    }

    .switch-btns[data-v-87ffcada] {
        height: 76px;
        cursor: pointer;
        padding-top: 24px;
        padding-bottom: 24px;
        border-bottom: 10px solid #f6f7fb;
        position: relative
    }

    .switch-btns[data-v-87ffcada]:before {
        content: " ";
        height: 1px;
        background: #e8e8e8;
        position: absolute;
        top: 0;
        left: 0;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        left: 1.375rem;
        right: 1.375rem
    }

    .switch-btns .btn[data-v-87ffcada] {
        height: 38px;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center
    }

    .switch-btns .btn .tag[data-v-87ffcada] {
        -webkit-box-flex: 0;
        -ms-flex: 0 0 62px;
        flex: 0 0 62px;
        text-align: center;
        color: #888;
        font-size: 14px;
        border-radius: 10px;
        height: 22px;
        line-height: 22px;
        background: #f6f7fb;
        font-weight: 400
    }

    .switch-btns .btn .txt[data-v-87ffcada] {
        margin-left: 10px;
        -webkit-box-flex: 1;
        -ms-flex: 1 1 auto;
        flex: 1 1 auto;
        color: #888;
        font-size: 15px;
        height: 22px;
        line-height: 22px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: 400
    }

    @media (max-width: 769px) {
        .article .breadcrumb[data-v-87ffcada] {
            padding-top: 10px;
            padding-bottom: 10px
        }
    }</style>
    <style type="text/css">.empty {
        height: 51px
    }

    .mobile-tips {
        width: 100%;
        height: 51px;
        background: rgba(0, 0, 0, .8);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 20;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        -webkit-box-pack: justify;
        -ms-flex-pack: justify;
        justify-content: space-between;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        padding: 0 12px;
        -webkit-transition: opacity .35s;
        transition: opacity .35s;
        opacity: 0;
        pointer-events: none
    }

    .mobile-tips.istop {
        opacity: 1;
        pointer-events: auto
    }

    .mobile-tips .mobile-tips-info {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        -webkit-box-pack: start;
        -ms-flex-pack: start;
        justify-content: flex-start
    }

    .mobile-tips .mobile-tips-info i {
        width: 36px;
        height: 36px;
        background-image: url(data:image/png;base64,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);
        background-position: 0 0;
        background-repeat: no-repeat;
        background-size: contain;
        border-radius: 7px
    }

    .mobile-tips .mobile-tips-info h2 {
        font-size: 15px;
        color: #fff;
        font-weight: 400;
        margin-left: 6px
    }

    .mobile-tips .mobile-tips-info h2 span {
        font-size: 11px
    }

    .mobile-tips a {
        width: 72px;
        height: 31px;
        text-align: center;
        border: 1px solid #fa8919;
        border-radius: 3px;
        font-size: 13px;
        color: #fa8919;
        line-height: 31px
    }</style>
    <style type="text/css">.share-poster-wrapper {
        position: fixed;
        background-color: #fff;
        left: 0;
        bottom: 0;
        z-index: 100;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        overflow: hidden;
        width: 100%;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -ms-flex-direction: column;
        flex-direction: column;
        -moz-user-select: -moz-none;
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none
    }

    .share-poster-wrapper .poster-bottom, .share-poster-wrapper .poster-middle, .share-poster-wrapper .poster-top {
        -ms-flex-negative: 0;
        flex-shrink: 0
    }

    .share-poster-wrapper .poster-middle {
        padding: 16px 32px;
        -webkit-box-sizing: border-box;
        box-sizing: border-box
    }

    .share-poster-wrapper .poster-middle .poster-userinfo {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        padding-bottom: 18px
    }

    .share-poster-wrapper .poster-middle .poster-userinfo .poster-avatar {
        min-width: 45px;
        min-height: 45px;
        width: 7vw;
        height: 7vw;
        border-radius: 50%;
        -ms-flex-negative: 0;
        flex-shrink: 0
    }

    .share-poster-wrapper .poster-middle .nickname {
        font-size: 5vw;
        font-weight: 400;
        margin-left: 18px
    }

    .share-poster-wrapper .poster-middle .time {
        font-size: 3.2vw
    }

    .share-poster-wrapper .poster-middle .poster-middle-content {
        font-size: 4vw;
        font-weight: 400;
        white-space: normal;
        word-wrap: break-word;
        word-break: break-word;
        letter-spacing: 1px
    }

    .share-poster-wrapper .poster-middle .poster-middle-content p {
        margin-bottom: 22px
    }

    .share-poster-wrapper .poster-middle .quote-content {
        font-size: 3.7vw;
        padding: 32px 0
    }

    .share-poster-wrapper .poster-middle .quote-content p {
        margin-bottom: 22px
    }

    .share-poster-wrapper .poster-middle .quote-info {
        border-left: 1px solid #000;
        padding-left: 10px;
        margin-top: 38px
    }

    .share-poster-wrapper .poster-middle .quote-info p {
        font-size: 3.2vw;
        line-height: 1.5
    }

    .share-poster-wrapper.theme0 .poster-top {
        width: 100%;
        height: 25px;
        margin-top: 27px;
        background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme1/top.png") no-repeat 15px 1px
    }

    .share-poster-wrapper.theme0 .poster-middle {
        width: 100%;
        padding-left: 56px;
        padding-right: 56px;
        background-image: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme1/middle.png");
        background-repeat: repeat-y;
        background-position: 15px 0
    }

    .share-poster-wrapper.theme0 .poster-middle .time {
        margin-bottom: 45px
    }

    .share-poster-wrapper.theme0 .poster-middle .quote-content {
        border-top: 1px solid #e3e1dc;
        margin-top: 30px
    }

    .share-poster-wrapper.theme0 .poster-bottom {
        width: 100%;
        height: 25px;
        margin-bottom: 27px;
        background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme1/bottom.png") no-repeat 15px -10px
    }

    .share-poster-wrapper.theme1 .poster-top {
        width: 100%;
        height: 25px;
        margin-top: 27px;
        background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme0/top.png") no-repeat 38px 1px
    }

    .share-poster-wrapper.theme1 .poster-middle {
        width: 100%;
        padding: 0 42px 10px;
        background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme0/middle.png") repeat-y 38px 0
    }

    .share-poster-wrapper.theme1 .poster-middle .poster-userinfo {
        border-bottom: 1px solid #b5a899
    }

    .share-poster-wrapper.theme1 .poster-middle .poster-userinfo .poster-avatar {
        margin-left: 38px
    }

    .share-poster-wrapper.theme1 .poster-middle .poster-middle-wrapper {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        min-height: 260px;
        border-bottom: 1px solid #b5a899
    }

    .share-poster-wrapper.theme1 .poster-middle .time {
        max-width: 65px;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -ms-flex-direction: column;
        flex-direction: column;
        -webkit-box-pack: center;
        -ms-flex-pack: center;
        justify-content: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        text-align: center;
        vertical-align: middle;
        border-right: 1px solid #b5a899
    }

    .share-poster-wrapper.theme1 .poster-middle .time span {
        white-space: nowrap;
        -webkit-transform: rotate(90deg);
        transform: rotate(90deg)
    }

    .share-poster-wrapper.theme1 .poster-middle .poster-middle-content {
        padding: 30px
    }

    .share-poster-wrapper.theme1 .poster-middle .quote-content {
        font-size: 3.7vw;
        margin-left: 36px;
        margin-right: 36px
    }

    .share-poster-wrapper.theme1 .poster-middle .quote-info {
        margin-left: 36px;
        margin-right: 36px
    }

    .share-poster-wrapper.theme1 .poster-middle .footer {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        margin-right: 30px
    }

    .share-poster-wrapper.theme1 .poster-bottom {
        width: 100%;
        height: 25px;
        margin-bottom: 27px;
        background: url("https://static001.geekbang.org/static/time/page/img/sharePoster/theme0/bottom.png") no-repeat 38px -10px
    }

    .share-poster-wrapper .share-poster {
        background: #fefdf8;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        color: #9b8d73;
        -webkit-box-flex: 1;
        -ms-flex-positive: 1;
        flex-grow: 1;
        overflow: auto;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -ms-flex-direction: column;
        flex-direction: column;
        -webkit-overflow-scrolling: touch;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center
    }

    .share-poster-wrapper .share-poster.color0 {
        background-color: #fefdf8
    }

    .share-poster-wrapper .share-poster.color1 {
        background-color: #4d4d4d
    }

    .share-poster-wrapper .share-poster .footer {
        margin-top: 2rem;
        position: relative;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -webkit-box-pack: end;
        -ms-flex-pack: end;
        justify-content: flex-end;
        -webkit-box-align: end;
        -ms-flex-align: end;
        align-items: flex-end
    }

    .share-poster-wrapper .share-poster .footer p {
        margin: 0;
        line-height: 1.4;
        margin-left: 20px;
        text-align: right;
        padding-right: 20px
    }

    .share-poster-wrapper .controls {
        background: #fff;
        border-top: 1px solid #f5f5f5;
        width: 100%;
        padding-top: 5px;
        -webkit-box-shadow: 0 -4px 10px 0 rgba(0, 0, 0, .1);
        box-shadow: 0 -4px 10px 0 rgba(0, 0, 0, .1);
        z-index: 1;
        -ms-flex-negative: 0;
        flex-shrink: 0
    }

    .share-poster-wrapper .controls > div {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -webkit-box-pack: center;
        -ms-flex-pack: center;
        justify-content: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        padding: 10px 0
    }

    .share-poster-wrapper .controls > div span {
        font-size: .85rem
    }

    .share-poster-wrapper .controls > div button {
        width: 100px;
        height: 24px;
        background: #eee;
        margin: 0 10px;
        border-radius: 5px;
        border: 2px solid #b2b2b2;
        outline: none
    }

    .share-poster-wrapper .controls > div button.on {
        border: 2px solid #ff5a05
    }

    .share-poster-wrapper .controls .controls-themes button {
        color: #b2b2b2;
        font-size: 12px;
        background: #fff;
        text-align: center
    }

    .share-poster-wrapper .controls .controls-themes button.on {
        color: #ff5a05
    }

    .share-poster-wrapper .buttons {
        background: #fff;
        border-top: 1px solid #f5f5f5;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -ms-flex-negative: 0;
        flex-shrink: 0
    }

    .share-poster-wrapper .buttons a {
        -webkit-box-flex: 1;
        -ms-flex-positive: 1;
        flex-grow: 1;
        text-align: center;
        color: #000;
        font-weight: 400;
        height: 3rem;
        line-height: 3rem
    }

    .share-poster-wrapper .buttons a .icon-share-money {
        width: 1rem;
        height: 1rem;
        margin: 3px 0 0 5px
    }

    .share-poster-wrapper .buttons a:last-child {
        border-left: 1px solid #f5f5f5
    }

    .share-poster-wrapper img {
        max-width: 100%
    }

    .share-poster-wrapper.android .poster-middle .nickname {
        font-size: 10vw
    }

    .share-poster-wrapper.android .poster-middle .time {
        font-size: 6.4vw
    }

    .share-poster-wrapper.android .poster-middle .poster-middle-content {
        font-size: 8vw
    }

    .share-poster-wrapper.android .poster-middle .quote-content {
        font-size: 7.4vw
    }

    .share-poster-wrapper.android .poster-middle .quote-info p {
        font-size: 6.4vw
    }</style>
    <style type="text/css">.mini-audio-player {
        width: 100%;
        height: 5.25rem;
        border: 1px solid #d9d9d9;
        background: #fafafa;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        padding: 1rem;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        -webkit-box-pack: justify;
        -ms-flex-pack: justify;
        justify-content: space-between;
        margin: 1rem 0
    }

    .mini-audio-player > a {
        border: none;
        -ms-flex-negative: 0;
        flex-shrink: 0
    }

    .mini-audio-player .btn-play {
        background-image: url(data:image/png;base64,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)
    }

    .mini-audio-player .btn-pause, .mini-audio-player .btn-play {
        width: 2.6875rem;
        height: 2.6875rem;
        background-repeat: no-repeat;
        background-position: 0 0;
        background-size: contain;
        text-decoration: none
    }

    .mini-audio-player .btn-pause {
        background-image: url(data:image/png;base64,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)
    }

    .mini-audio-player .audio-info {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-flex: 1;
        -ms-flex-positive: 1;
        flex-grow: 1;
        -webkit-box-orient: vertical;
        -webkit-box-direction: normal;
        -ms-flex-direction: column;
        flex-direction: column;
        margin-left: .6875rem;
        min-width: 0
    }

    .mini-audio-player .audio-info h3 {
        color: #353535;
        font-size: 15.25px;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis
    }

    .mini-audio-player .audio-info p {
        margin: 0;
        margin-top: .125rem;
        font-size: 11px;
        line-height: 1rem
    }

    .mini-audio-player .audio-info p span {
        color: #888
    }

    .mini-audio-player .btn-download {
        width: 1.25rem;
        height: 1.25rem;
        position: relative;
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAA+CAYAAACbQR1vAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxMzggNzkuMTU5ODI0LCAyMDE2LzA5LzE0LTAxOjA5OjAxICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+IEmuOgAAA4hJREFUaIHtm8lOFFEUhr9qCWGHGxcaY1joK2h0YRzAtYmsWbAGGidEXOACbAYRxfgAPoEPoInGxJgg86gsJTHMw86EhS7O7TDk3uqq6qo6HahvQ7pOce7//1U0feve9vr6+lAiD3QC/4AC8FZDRJXGoMB14PWB1yPANPA1bSG5tAc0XLEcu5y6CvQCOGU5pnI3agVQMWQBaAvQJgtAW4A2WQDaArTJAtAWoE0WgLYAbbIAtAVokwWgLUCbLABtAdpkAfjU6oC7wKV0pCTCRcRDnesEVwDNwC/gg/nZHbeyFOgGltj30Gw7yRZALfAOqDavPeA50BO7xOToQTR75nU14qn26Im2AM4DNZbjz4DeePQlSi+i9Sg1iLdD2AJYApYdzbuo7BBeIBptLCPeDmELYA9oBHYdjbqQpaxKowA8ddR2gXuIt0O43gRHgTu4Q+ikskIoIJps7AINwA9b0e/fYJAQ1FZWD9CP2/wOUI/DPJT+IDRqGrhCeGIEaNEPdDhqO8iVH/NrEOST4BgSwo6j3gEMBOgTNwP4m6+nhHkI/lG4VAiPgcGAveJg0IxpYxvROh6kUZi5wLhpvO2oPyKdEF6asWyEMg/hJ0PjyN+VXwhDIXuGYQh46KhtIeYnwjSMMhss3glbjvoDkglhyPS2Eck8RJ8OTyB3gl8IryL2tjGM2/wmYn4ySuNyngdMmIE3HfX7iHDPUQ+CZ3q0O+qbyIWIZB7KfyAyaQS4QmhH7oQoIZQyv0EZV75IHE+EJvG/E9oJfyd4yC6yvKO+gQQ/FaKnlbgeiU0hIWw46nnEUJAQiubbHPV1M1bZ5iHeZ4KlQmgD3uAfgofsGfQz34DsKYyFuLemTSMhfATOWOqtiMk/llrRfIuj9zpwG5gtX+Y+SezNK4bwCXsILdgDaAXOOnomYh6Seyw+gwhed9TPWY75mb9FAuYh2XWBWUS4K4QgrAE3gblYFFlIemFkDjEQJYQ1JMD5WBUdIY2VoXkkhLUQv7NqfidR85De0liYEFaRK7+QqCJDmmuDC0gIqz7nrJhzUjEP6S+O+oWwglz5xTQFaawOLwI3gO8Hjo2ZY6maB72vzPwErgEXkO8MuVaiEkcrgCK/lcfPNkhkAWgL0KYKmZiMIG9Ktn0Bx5G/wDcgXwW8R6avJ41G4HQOufInlas5ZO5+UpnJAU3AFyy7J44xe8BnoOk/JruwYo92bigAAAAASUVORK5CYII=);
        background-repeat: no-repeat;
        background-position: 0 0;
        background-size: contain;
        text-decoration: none;
        padding-right: .25rem
    }

    .mini-audio-player .btn-download .icon-download-done {
        width: .45rem;
        height: .45rem;
        position: absolute;
        bottom: 0;
        right: 0;
        display: inline-block;
        background-image: url(data:image/png;base64,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);
        background-repeat: no-repeat;
        background-position: 0 0;
        background-size: contain
    }</style>
    <style type="text/css">.MathJax_Display {
        overflow: auto
    }

    .poster {
        position: fixed;
        left: -10000px;
        top: -10000px;
        overflow: hidden;
        padding: 1rem;
        background: #ececec
    }

    .richcontent-pre-copy {
        font-size: 13px;
        color: #888;
        position: absolute;
        right: 1em;
        top: .2em;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none
    }

    .richcontent-pre-copy .iconfont {
        font-size: 12px;
        margin-right: .2em
    }</style>
    <style type="text/css">.breadcrumb {
        padding: 30px 0;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        background: #fff
    }

    .breadcrumb a.title {
        color: #e57c39;
        font-size: 15px;
        font-weight: 400
    }

    .breadcrumb span.title {
        color: #888;
        font-size: 15px;
        font-weight: 400
    }

    .breadcrumb .split {
        color: #ccc;
        font-size: 10px;
        margin-right: 5px
    }</style>
    <style type="text/css">.comment-item {
        list-style-position: inside;
        width: 100%;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        margin-bottom: 1rem
    }

    .comment-item a {
        border-bottom: none
    }

    .comment-item .avatar {
        width: 2.625rem;
        height: 2.625rem;
        -ms-flex-negative: 0;
        flex-shrink: 0;
        border-radius: 50%
    }

    .comment-item .info {
        margin-left: .5rem;
        -webkit-box-flex: 1;
        -ms-flex-positive: 1;
        flex-grow: 1
    }

    .comment-item .info .hd {
        width: 100%;
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -webkit-box-pack: justify;
        -ms-flex-pack: justify;
        justify-content: space-between;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center
    }

    .comment-item .info .hd .username {
        color: #888;
        font-size: 15.25px;
        font-weight: 400;
        line-height: 1.2
    }

    .comment-item .info .hd .control {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center
    }

    .comment-item .info .hd .control .btn-share {
        color: #888;
        font-size: .75rem;
        margin-right: 1rem
    }

    .comment-item .info .hd .control .btn-praise {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
        font-size: 15.25px;
        text-decoration: none
    }

    .comment-item .info .hd .control .btn-praise i {
        color: #888;
        display: inline-block;
        font-size: .75rem;
        margin-right: .3rem;
        margin-top: -.01rem
    }

    .comment-item .info .hd .control .btn-praise i.on, .comment-item .info .hd .control .btn-praise span {
        color: #fa8919
    }

    .comment-item .info .bd {
        color: #353535;
        font-size: 15.25px;
        font-weight: 400;
        white-space: normal;
        word-break: break-all;
        line-height: 1.6
    }

    .comment-item .info .time {
        color: #888;
        font-size: 9px;
        line-height: 1
    }

    .comment-item .info .reply .reply-hd {
        font-size: 15.25px
    }

    .comment-item .info .reply .reply-hd span {
        margin-left: -12px;
        color: #888;
        font-weight: 400
    }

    .comment-item .info .reply .reply-hd i {
        color: #fa8919;
        font-size: 15.25px
    }

    .comment-item .info .reply .reply-content {
        color: #353535;
        font-size: 15.25px;
        font-weight: 400;
        white-space: normal;
        word-break: break-all
    }

    .comment-item .info .reply .reply-time {
        color: #888;
        font-size: 9px
    }

    .comment-template {
        display: none;
    }
    </style>
</head>
<body>

<div id="app">
    <div data-v-87ffcada="" class="article"><!---->
        <div data-v-87ffcada="" class="main main-app">
            <h1 data-v-87ffcada="" class="article-title pd">
                01 | 可见性、原子性和有序性问题：并发编程Bug的源头
            </h1>
            <div data-v-87ffcada="" class="article-info pd"><span data-v-87ffcada="">2019-02-28</span> <span data-v-87ffcada="">王宝令</span></div>
            <div data-v-87ffcada="" class="article-content typo common-content pd">
                <img data-v-87ffcada="" src="https://static001.geekbang.org/resource/image/bd/de/bdc7db1361d308d905a7685b0e18dede.jpg">
                <!---->
                <div data-v-87ffcada="" class="mini-audio-player">
                    <div class="audio-info">
                        <p><span>朗读人：王宝令&nbsp;&nbsp;&nbsp;</span>
                        </p></div> <!---->
                    <audio title="" src="https://static001.geekbang.org/resource/audio/76/87/76dd72495809859e8bc0e454313df487.mp3" controls="controls"></audio>
                </div>
                <div data-v-87ffcada="" id="article-content" class="">
                    <div class="text"><p>如果你细心观察的话，你会发现，不管是哪一门编程语言，并发类的知识都是在高级篇里。换句话说，这块知识点其实对于程序员来说，是比较进阶的知识。我自己这么多年学习过来，也确实觉得并发是比较难的，因为它会涉及到很多的底层知识，比如若你对操作系统相关的知识一无所知的话，那去理解一些原理就会费些力气。这是我们整个专栏的第一篇文章，我说这些话的意思是如果你在中间遇到自己没想通的问题，可以去查阅资料，也可以在评论区找我，以保证你能够跟上学习进度。</p><p>你我都知道，编写正确的并发程序是一件极困难的事情，并发程序的Bug往往会诡异地出现，然后又诡异地消失，很难重现，也很难追踪，很多时候都让人很抓狂。但要快速而又精准地解决“并发”类的疑难杂症，你就要理解这件事情的本质，追本溯源，深入分析这些Bug的源头在哪里。</p><p>那为什么并发编程容易出问题呢？它是怎么出问题的？今天我们就重点聊聊这些Bug的源头。</p><h2>并发程序幕后的故事</h2><p>这些年，我们的CPU、内存、I/O设备都在不断迭代，不断朝着更快的方向努力。但是，在这个快速发展的过程中，有一个<strong>核心矛盾一直存在，就是这三者的速度差异</strong>。CPU和内存的速度差异可以形象地描述为：CPU是天上一天，内存是地上一年（假设CPU执行一条普通指令需要一天，那么CPU读写内存得等待一年的时间）。内存和I/O设备的速度差异就更大了，内存是天上一天，I/O设备是地上十年。</p><!-- [[[read_end]]] --><p>程序里大部分语句都要访问内存，有些还要访问I/O，根据木桶理论（一只水桶能装多少水取决于它最短的那块木板），程序整体的性能取决于最慢的操作——读写I/O设备，也就是说单方面提高CPU性能是无效的。</p><p>为了合理利用CPU的高性能，平衡这三者的速度差异，计算机体系机构、操作系统、编译程序都做出了贡献，主要体现为：</p><ol>
<li>CPU增加了缓存，以均衡与内存的速度差异；</li>
<li>操作系统增加了进程、线程，以分时复用CPU，进而均衡CPU与I/O设备的速度差异；</li>
<li>编译程序优化指令执行次序，使得缓存能够得到更加合理地利用。</li>
</ol><p>现在我们几乎所有的程序都默默地享受着这些成果，但是天下没有免费的午餐，并发程序很多诡异问题的根源也在这里。</p><h2>源头之一：缓存导致的可见性问题</h2><p>在单核时代，所有的线程都是在一颗CPU上执行，CPU缓存与内存的数据一致性容易解决。因为所有线程都是操作同一个CPU的缓存，一个线程对缓存的写，对另外一个线程来说一定是可见的。例如在下面的图中，线程A和线程B都是操作同一个CPU里面的缓存，所以线程A更新了变量V的值，那么线程B之后再访问变量V，得到的一定是V的最新值（线程A写过的值）。</p><p><img src="https://static001.geekbang.org/resource/image/a0/da/a07e8182819e2b260ce85b2167d446da.png" alt=""></p><center><span class="reference">CPU缓存与内存的关系图</span></center><p>一个线程对共享变量的修改，另外一个线程能够立刻看到，我们称为<strong>可见性</strong>。</p><p>多核时代，每颗CPU都有自己的缓存，这时CPU缓存与内存的数据一致性就没那么容易解决了，当多个线程在不同的CPU上执行时，这些线程操作的是不同的CPU缓存。比如下图中，线程A操作的是CPU-1上的缓存，而线程B操作的是CPU-2上的缓存，很明显，这个时候线程A对变量V的操作对于线程B而言就不具备可见性了。这个就属于硬件程序员给软件程序员挖的“坑”。</p><p><img src="https://static001.geekbang.org/resource/image/e2/ea/e2aa76928b2bc135e08e7590ca36e0ea.png" alt=""></p><center><span class="reference">多核CPU的缓存与内存关系图</span></center><p>下面我们再用一段代码来验证一下多核场景下的可见性问题。下面的代码，每执行一次add10K()方法，都会循环10000次count+=1操作。在calc()方法中我们创建了两个线程，每个线程调用一次add10K()方法，我们来想一想执行calc()方法得到的结果应该是多少呢？</p><pre><code>public class Test {
  private long count = 0;
  private void add10K() {
    int idx = 0;
    while(idx++ &lt; 10000) {
      count += 1;
    }
  }
  public static long calc() {
    final Test test = new Test();
    // 创建两个线程，执行add()操作
    Thread th1 = new Thread(()-&gt;{
      test.add10K();
    });
    Thread th2 = new Thread(()-&gt;{
      test.add10K();
    });
    // 启动两个线程
    th1.start();
    th2.start();
    // 等待两个线程执行结束
    th1.join();
    th2.join();
    return count;
  }
}
</code></pre><p>直觉告诉我们应该是20000，因为在单线程里调用两次add10K()方法，count的值就是20000，但实际上calc()的执行结果是个10000到20000之间的随机数。为什么呢？</p><p>我们假设线程A和线程B同时开始执行，那么第一次都会将 count=0 读到各自的CPU缓存里，执行完 count+=1 之后，各自CPU缓存里的值都是1，同时写入内存后，我们会发现内存中是1，而不是我们期望的2。之后由于各自的CPU缓存里都有了count的值，两个线程都是基于CPU缓存里的 count 值来计算，所以导致最终count的值都是小于20000的。这就是缓存的可见性问题。</p><p>循环10000次count+=1操作如果改为循环1亿次，你会发现效果更明显，最终count的值接近1亿，而不是2亿。如果循环10000次，count的值接近20000，原因是两个线程不是同时启动的，有一个时差。</p><p><img src="https://static001.geekbang.org/resource/image/ec/79/ec6743e74ccf9a3c6d6c819a41e52279.png" alt=""></p><center><span class="reference">变量count在CPU缓存和内存的分布图</span></center><h2>源头之二：线程切换带来的原子性问题</h2><p>由于IO太慢，早期的操作系统就发明了多进程，即便在单核的CPU上我们也可以一边听着歌，一边写Bug，这个就是多进程的功劳。</p><p>操作系统允许某个进程执行一小段时间，例如50毫秒，过了50毫秒操作系统就会重新选择一个进程来执行（我们称为“任务切换”），这个50毫秒称为“<strong>时间片</strong>”。</p><p><img src="https://static001.geekbang.org/resource/image/25/fb/254b129b145d80e9bb74123d6e620efb.png" alt=""></p><center><span class="reference">线程切换示意图</span></center><p>在一个时间片内，如果一个进程进行一个IO操作，例如读个文件，这个时候该进程可以把自己标记为“休眠状态”并出让CPU的使用权，待文件读进内存，操作系统会把这个休眠的进程唤醒，唤醒后的进程就有机会重新获得CPU的使用权了。</p><p>这里的进程在等待IO时之所以会释放CPU使用权，是为了让CPU在这段等待时间里可以做别的事情，这样一来CPU的使用率就上来了；此外，如果这时有另外一个进程也读文件，读文件的操作就会排队，磁盘驱动在完成一个进程的读操作后，发现有排队的任务，就会立即启动下一个读操作，这样IO的使用率也上来了。</p><p>是不是很简单的逻辑？但是，虽然看似简单，支持多进程分时复用在操作系统的发展史上却具有里程碑意义，Unix就是因为解决了这个问题而名噪天下的。</p><p>早期的操作系统基于进程来调度CPU，不同进程间是不共享内存空间的，所以进程要做任务切换就要切换内存映射地址，而一个进程创建的所有线程，都是共享一个内存空间的，所以线程做任务切换成本就很低了。现代的操作系统都基于更轻量的线程来调度，现在我们提到的“任务切换”都是指“线程切换”。</p><p>Java并发程序都是基于多线程的，自然也会涉及到任务切换，也许你想不到，任务切换竟然也是并发编程里诡异Bug的源头之一。任务切换的时机大多数是在时间片结束的时候，我们现在基本都使用高级语言编程，高级语言里一条语句往往需要多条CPU指令完成，例如上面代码中的<code>count += 1</code>，至少需要三条CPU指令。</p><ul>
<li>指令1：首先，需要把变量count从内存加载到CPU的寄存器；</li>
<li>指令2：之后，在寄存器中执行+1操作；</li>
<li>指令3：最后，将结果写入内存（缓存机制导致可能写入的是CPU缓存而不是内存）。</li>
</ul><p>操作系统做任务切换，可以发生在任何一条<strong>CPU指令</strong>执行完，是的，是CPU指令，而不是高级语言里的一条语句。对于上面的三条指令来说，我们假设count=0，如果线程A在指令1执行完后做线程切换，线程A和线程B按照下图的序列执行，那么我们会发现两个线程都执行了count+=1的操作，但是得到的结果不是我们期望的2，而是1。</p><p><img src="https://static001.geekbang.org/resource/image/33/63/33777c468872cb9a99b3cdc1ff597063.png" alt=""></p><center><span class="reference">非原子操作的执行路径示意图</span></center><p>我们潜意识里面觉得count+=1这个操作是一个不可分割的整体，就像一个原子一样，线程的切换可以发生在count+=1之前，也可以发生在count+=1之后，但就是不会发生在中间。<strong>我们把一个或者多个操作在CPU执行的过程中不被中断的特性称为原子性</strong>。CPU能保证的原子操作是CPU指令级别的，而不是高级语言的操作符，这是违背我们直觉的地方。因此，很多时候我们需要在高级语言层面保证操作的原子性。</p><h2>源头之三：编译优化带来的有序性问题</h2><p>那并发编程里还有没有其他有违直觉容易导致诡异Bug的技术呢？有的，就是有序性。顾名思义，有序性指的是程序按照代码的先后顺序执行。编译器为了优化性能，有时候会改变程序中语句的先后顺序，例如程序中：“a=6；b=7；”编译器优化后可能变成“b=7；a=6；”，在这个例子中，编译器调整了语句的顺序，但是不影响程序的最终结果。不过有时候编译器及解释器的优化可能导致意想不到的Bug。</p><p>在Java领域一个经典的案例就是利用双重检查创建单例对象，例如下面的代码：在获取实例getInstance()的方法中，我们首先判断instance是否为空，如果为空，则锁定Singleton.class并再次检查instance是否为空，如果还为空则创建Singleton的一个实例。</p><pre><code>public class Singleton {
  static Singleton instance;
  static Singleton getInstance(){
    if (instance == null) {
      synchronized(Singleton.class) {
        if (instance == null)
          instance = new Singleton();
        }
    }
    return instance;
  }
}
</code></pre><p>假设有两个线程A、B同时调用getInstance()方法，他们会同时发现 <code>instance == null</code> ，于是同时对Singleton.class加锁，此时JVM保证只有一个线程能够加锁成功（假设是线程A），另外一个线程则会处于等待状态（假设是线程B）；线程A会创建一个Singleton实例，之后释放锁，锁释放后，线程B被唤醒，线程B再次尝试加锁，此时是可以加锁成功的，加锁成功后，线程B检查 <code>instance == null</code> 时会发现，已经创建过Singleton实例了，所以线程B不会再创建一个Singleton实例。</p><p>这看上去一切都很完美，无懈可击，但实际上这个getInstance()方法并不完美。问题出在哪里呢？出在new操作上，我们以为的new操作应该是：</p><ol>
<li>分配一块内存M；</li>
<li>在内存M上初始化Singleton对象；</li>
<li>然后M的地址赋值给instance变量。</li>
</ol><p>但是实际上优化后的执行路径却是这样的：</p><ol>
<li>分配一块内存M；</li>
<li>将M的地址赋值给instance变量；</li>
<li>最后在内存M上初始化Singleton对象。</li>
</ol><p>优化后会导致什么问题呢？我们假设线程A先执行getInstance()方法，当执行完指令2时恰好发生了线程切换，切换到了线程B上；如果此时线程B也执行getInstance()方法，那么线程B在执行第一个判断时会发现 <code>instance != null</code> ，所以直接返回instance，而此时的instance是没有初始化过的，如果我们这个时候访问 instance 的成员变量就可能触发空指针异常。</p><p><img src="https://static001.geekbang.org/resource/image/64/d8/64c955c65010aae3902ec918412827d8.png" alt=""></p><center><span class="reference">双重检查创建单例的异常执行路径</span></center><h2>总结</h2><p>要写好并发程序，首先要知道并发程序的问题在哪里，只有确定了“靶子”，才有可能把问题解决，毕竟所有的解决方案都是针对问题的。并发程序经常出现的诡异问题看上去非常无厘头，但是深究的话，无外乎就是直觉欺骗了我们，<strong>只要我们能够深刻理解可见性、原子性、有序性在并发场景下的原理，很多并发Bug都是可以理解、可以诊断的</strong>。</p><p>在介绍可见性、原子性、有序性的时候，特意提到<strong>缓存</strong>导致的可见性问题，<strong>线程切换</strong>带来的原子性问题，<strong>编译优化</strong>带来的有序性问题，其实缓存、线程、编译优化的目的和我们写并发程序的目的是相同的，都是提高程序性能。但是技术在解决一个问题的同时，必然会带来另外一个问题，所以<strong>在采用一项技术的同时，一定要清楚它带来的问题是什么，以及如何规避</strong>。</p><p>我们这个专栏在讲解每项技术的时候，都会尽量将每项技术解决的问题以及产生的问题讲清楚，也希望你能够在这方面多思考、多总结。</p><h2>课后思考</h2><p>常听人说，在32位的机器上对long型变量进行加减操作存在并发隐患，到底是不是这样呢？现在相信你一定能分析出来。</p><p>欢迎在留言区与我分享你的想法，也欢迎你在留言区记录你的思考过程。感谢阅读，如果你觉得这篇文章对你有帮助的话，也欢迎把它分享给更多的朋友。</p><p><img src="https://static001.geekbang.org/resource/image/cf/aa/cf393cd748a4f0e6451807c4b61843aa.jpg" alt=""></p></div>
                </div> <!---->
                <div data-v-87ffcada="" class="copyright">
                    ©版权归极客邦科技所有，未经许可不得转载
                </div>
            </div>
            <div data-v-87ffcada="" class="article-comments pd"><h2 data-v-87ffcada=""><span data-v-87ffcada="">精选留言</span></h2>
                <ul data-v-87ffcada="">

                    <li data-v-87ffcada="" class="comment-item comment-template">
                        <img src="${user_header}" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">${user_name}</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">${like_count}</span></a></div>
                            </div>
                            <div class="bd comment-content">${comment_content}
                            </div>
                            <span class="time">${comment_ctime}</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">${user_name}</span></div>
                                <p class="reply-content">${content}</p>
                                <p class="reply-time">${ctime}</p></div>
                        </div>
                    </li>
                <li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/fb/7b/7006a759.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Jialin</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">186</span></a></div>
                            </div>
                            <div class="bd comment-content">对于双重锁的问题，我觉得任大鹏分析的蛮有道理，线程A进入第二个判空条件，进行初始化时，发生了时间片切换，即使没有释放锁，线程B刚要进入第一个判空条件时，发现条件不成立，直接返回instance引用，不用去获取锁。如果对instance进行volatile语义声明，就可以禁止指令重排序，避免该情况发生。<br>对于有些同学对CPU缓存和内存的疑问，CPU缓存不存在于内存中的，它是一块比内存更小、读写速度更快的芯片，至于什么时候把数据从缓存写到内存，没有固定的时间，同样地，对于有volatile语义声明的变量，线程A执行完后会强制将值刷新到内存中，线程B进行相关操作时会强制重新把内存中的内容写入到自己的缓存，这就涉及到了volatile的写入屏障问题，当然也就是所谓happen-before问题。</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">厉害厉害，比我回答的全面多了</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/5b/79/0290c0bd.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">json</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">98</span></a></div>
                            </div>
                            <div class="bd comment-content">long类型64位，所以在32位的机器上，对long类型的数据操作通常需要多条指令组合出来，无法保证原子性，所以并发的时候会出问题🌝🌝🌝</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">正解</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/4f/f9/1f0a9665.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">任大鹏</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">76</span></a></div>
                            </div>
                            <div class="bd comment-content">对于阿根一世同学的那个疑问，我个人认为CPU时间片切换后，线程B刚好执行到第一次判断instance==null，此时不为空，不用进入synchronized里，就将还未初始化的instance返回了</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">正解！感谢回复。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/03/10/15f82d62.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">阿根一世</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">72</span></a></div>
                            </div>
                            <div class="bd comment-content">对于双重锁检查那个例子，我有一个疑问，A如果没有完成实例的初始化，锁应该不会释放的，B是拿不到锁的，怎么还会出问题呢？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">后面好多同学已经帮我作答了，教好学生，饿死师傅啊</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/cf/0c/734c653d.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Blithe</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">45</span></a></div>
                            </div>
                            <div class="bd comment-content">对于阿根一世的提问，以及文中作者的描述，我有自己的看法。阿根一世的提问是对的，作者的描述是有误的，但作者的结论是正确的。<br>我的解释如下：两个线程都过了第一层判空后，第二个线程不会出现文中说的空指针异常。因为JSR-133中的happens-before规则。1.一个线程中的每个操作先于线程中的后续操作。2.对一个锁的解锁先于随后对这个锁的解锁。3.传递行。综合以上三条规则，第一个线程的对象初始化完成先于解锁，第一个线程的解锁先于第二个线程的加锁。所以，真如作者所说第二线程如果过了第一层的判空校验，下步就要加锁，加锁后其实对象在线程一中已经初始化结束，不会出现NPE。但例子的确会出现NPE问题，出现的场景却是，线程二没有进行到第一层判空操作，线程一到了文中说的时间片结束，让出CPU，线程二判空，否，执行对象调用方法。有问题，可加微信交流Blithe-Feng</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">我看了一下，的确是我的描述有问题。感谢啊！<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/31/f4/6cb4302e.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">CHEN</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">32</span></a></div>
                            </div>
                            <div class="bd comment-content">刚看过《java并发实战》，又是看了个开始就看不下去了😂😂，希望订阅专栏可以跟老师和其他童鞋一起坚持学习并发编程😄😄<br><br>思考题：在32位的机器上对long型变量进行加减操作存在并发隐患的说法是正确的。<br>原因就是文章里的bug源头之二：线程切换带来的原子性问题。<br>非volatile类型的long和double型变量是8字节64位的，32位机器读或写这个变量时得把人家咔嚓分成两个32位操作，可能一个线程读了某个值的高32位，低32位已经被另一个线程改了。所以官方推荐最好把long\double 变量声明为volatile或是同步加锁synchronize以避免并发问题。<br><br>贴一段java文档的说明<br>https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.7<br><br>17.7. Non-Atomic Treatment of double and long<br><br>For the purposes of the Java programming language memory model, a single write to a non-volatile long or double value is treated as two separate writes: one to each 32-bit half. This can result in a situation where a thread sees the first 32 bits of a 64-bit value from one write, and the second 32 bits from another write.<br><br>Writes and reads of volatile long and double values are always atomic.<br><br>Writes to and reads of references are always atomic, regardless of whether they are implemented as 32-bit or 64-bit values.<br><br>Some implementations may find it convenient to divide a single write action on a 64-bit long or double value into two write actions on adjacent 32-bit values. For efficiency's sake, this behavior is implementation-specific; an implementation of the Java Virtual Machine is free to perform writes to long and double values atomically or in two parts.<br><br>Implementations of the Java Virtual Machine are encouraged to avoid splitting 64-bit values where possible. Programmers are encouraged to declare shared 64-bit values as volatile or synchronize their programs correctly to avoid possible complications.</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">厉害厉害</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/02/a2/6ff070ee.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">嘎嘎</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">31</span></a></div>
                            </div>
                            <div class="bd comment-content">针对阿根一世的问题，问题其实出现在new Singleton()这里。<br>这一行分对于CPU来讲，有3个指令：<br>1.分配内存空间<br>2.初始化对象<br>3.instance引用指向内存空间<br>正常执行顺序1-2-3<br>但是CPU重排序后执行顺序可能为1-3-2，那么问题就来了<br>步骤如下：<br>1.A、B线程同时进入了第一个if判断<br>2.A首先进入synchronized块，由于instance为null，所以它执行instance = new Singleton();<br>3.然后线程A执行1-&gt; JVM先画出了一些分配给Singleton实例的空白内存，并赋值给instance<br>4.在还没有进行第三步（将instance引用指向内存空间）的时候，线程A离开了synchronized块<br>5.线程B进入synchronized块，读取到了A线程返回的instance，此时这个instance并未进行物理地址指向，是一个空对象。<br>有人说将对象设置成volatile，其实也不能完全解决问题。volatile只是保证可见性，并不保证原子性。<br><br>现行的比较通用的做法就是采用静态内部类的方式来实现。<br>public class MySingleton {<br>	<br>	//内部类<br>	private static class MySingletonHandler{<br>		private static MySingleton instance = new MySingleton();<br>	} <br>	<br>	private MySingleton(){}<br>	 <br>	public static MySingleton getInstance() { <br>		return MySingletonHandler.instance;<br>	}<br>}</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">厉害，一看就是经验丰富</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/52/97/8f960ce9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">xx鼠</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">28</span></a></div>
                            </div>
                            <div class="bd comment-content">Singleton instance改为volatile或者final就完美了，这里面其实涉及Java的happen-before原则。</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">恭喜你，学会抢答了！</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/5b/73/23040664.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">summer_Day</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">17</span></a></div>
                            </div>
                            <div class="bd comment-content">我觉得阿根一世的问题应该是<br>synchronized(Singleton.class) {<br>        if (instance == null)<br>          instance = new Singleton();<br>        }<br>对于synchronized关键字已经对代码块进行加锁了<br>我理解应该等价于<br>synchronized(Singleton.class) {<br>        if (instance == null) {<br>          分配一块内存 M；<br>          将 M 的地址赋值给 instance 变量；<br>          最后在内存 M 上初始化 Singleton 对象。<br>        }<br>  }<br> A如果没有完成实例的初始化，锁应该不会释放的，B是拿不到锁的，怎么还会出问题呢？<br></div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">落墨</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">16</span></a></div>
                            </div>
                            <div class="bd comment-content">老师,运行文中的测试代码,有时会出现9000多的结果,不知道是什么原因?</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">并发程序的诡异之处，就在于：我实在也想不通。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eqHMAwG4atmGJ6H1cs1o3yUE2UhEian6cmbp9BWC1V2S7zAQdQHWYtaZbjahKHsMSkje5GrGjo9Iug/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">我会得到</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">11</span></a></div>
                            </div>
                            <div class="bd comment-content">零点一过刚好看到更新，果断一口气读完，带劲！可见性，原子性，有序性，操作系统作为基础，内存模型，机器指令，编译原理，一个都不能少，开始有点意思了👍</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">后面讲内存模型，会更有意思。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/f7/0a/067537fc.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">别皱眉</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">8</span></a></div>
                            </div>
                            <div class="bd comment-content">周末了<br>对留言问题总结一下<br>&nbsp;<br>------可见性问题------<br>对于可见性那个例子我们先看下定义:<br>可见性:一个线程对共享变量的修改，另外一个线程能够立刻看到<br>&nbsp;<br>并发问题往往都是综合证，这里即使是单核CPU，只要出现线程切换就会有原子性问题。但老师的目的是为了让大家明白什么是可见性<br>或许我们可以把线程对变量的读可写都看作时原子操作，也就是cpu对变量的操作中间状态不可见，这样就能更加理解什么是可见性了。<br>&nbsp;<br>------CPU缓存刷新到内存的时机------<br>cpu将缓存写入内存的时机是不确定的。除非你调用cpu相关指令强刷<br>&nbsp;<br>------双重锁问题------<br>如果A线程与B线程如果同时进入第一个分支，那么这个程序就没有问题<br>&nbsp;<br>如果A线程先获取锁并出现指令重排序时，B线程未进入第一个分支，那么就可能出现空指针问题，这里说可能出现问题是因为当把内存地址赋值给共享变量后，CPU将数据写回缓存的时机是随机的<br>&nbsp;<br>------ synchronized------<br>线程在synchronized块中，发生线程切换，锁是不会释放的<br>&nbsp;<br>------指令优化------<br>除了编译优化,有一部分可以通过看汇编代码来看，但是CPU和解释器在运行期也会做一部分优化，所以很多时候都是看不到的，也很难重现。<br>&nbsp;<br>------JMM模型和物理内存、缓存等关系------<br>内存、cpu缓存是物理存在，jvm内存是软件存在的。<br>关于线程的工作内存和寄存器、cpu缓存的关系 大家可以参考这篇文章<br>https://blog.csdn.net/u013851082/article/details/70314778/<br>&nbsp;<br>------IO操作------<br>io操作不占用cpu，读文件，是设备驱动干的事，cpu只管发命令。发完命令，就可以干别的事情了。<br>&nbsp;<br>&nbsp;<br>------寄存器切换------&nbsp;<br>寄存器是共用的，A线程切换到B线程的时候，寄存器会把操作A的相关内容会保存到内存里，切换回来的时候，会从内存把内容加载到寄存器。可以理解为每个线程有自己的寄存器<br>&nbsp;<br>请老师帮忙看看，有没问题。希望我的总结能帮到更多人😄😄</div>
                            <span class="time">2019-03-16</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">没问题，总结的太到位了！！！</p>
                                <p class="reply-time">2019-03-16</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/e4/76/a97242c0.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">黄朋飞</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">8</span></a></div>
                            </div>
                            <div class="bd comment-content">老师你好，请问文章中的缓存和内存什么区别，缓存不是在内存中存放着吗？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">对不起，是我没说清楚，这里的缓存，指的是CPU缓存。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/a2/f3/aa504fa6.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">波波</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">7</span></a></div>
                            </div>
                            <div class="bd comment-content">为老师点赞，讲了并发产生的前世今生，通俗易懂又不失深度。</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">这么夸我，我真的会骄傲的<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/48/1b/7de6e72e.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">牧童纪年</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">6</span></a></div>
                            </div>
                            <div class="bd comment-content">王老师，你文章中讲的 优化指令的执行次序 使得缓存能够更加合理的利用是什么意思？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">比如第1行：a=8<br>第1000行：a=a*2;<br>这个时候，把他们放到一起执行，是不是就能更好的利用缓存了？</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/4c/12/6d9493c3.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">rayjun</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">5</span></a></div>
                            </div>
                            <div class="bd comment-content">第一个测试代码是不是有点问题，在静态方法中怎么能访问非静态变量呢？</div>
                            <span class="time">2019-03-03</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">我本地测试的代码是下面这样的，为了说明问题，为了不占用篇幅，做了删减。final Test test = new Test();使用test访问的，所以可以访问<br><br>public class Test {<br>    private int count = 0;<br>    private void add() {<br>        int idx = 0;<br>        while(idx++ &lt; 10000000) {<br>            count += 1;<br>        }<br>    }<br>    public static int calc() throws Exception {<br>        final Test test = new Test();<br>        Thread th1 = new Thread(()-&gt;{<br>            test.add();<br>        });<br>        Thread th2 = new Thread(()-&gt;{<br>            test.add();<br>        });<br><br>        th1.start();<br>        th2.start();<br>        th1.join();<br>        th2.join();<br>        return test.count;<br>    }<br><br>    public static void main(String[] args) throws Exception {<br>        long c =calc();<br>        System.out.println(c);<br>    }<br>}<br></p>
                                <p class="reply-time">2019-03-03</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/06/62/898449d3.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">... ...</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">5</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，上面的两个线程的例子应该不是可见性导致而是原子性导致的吧！如果是可见性导致的话，我在变量count上加个volatile应该可以解决问题啊！还发现个小问题，非静态变量应该不能直接用于静态方法中吧！</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">示例代码，只是为了说明问题。考虑到大家手机屏幕的尺寸，能省就省了<br>这个例子不仅仅是可见性的问题，并发问题往往都是综合证。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/36/d2/c7357723.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">发条橙子 。</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">5</span></a></div>
                            </div>
                            <div class="bd comment-content">老师 ，我有几个问题希望老师指点 ，也是涉及到操作系统的：<br><br>1.  操作系统是以进程为单位共享资源 ，以线程单位进行调用 。 多个线程共享一个进程的资源 。 一个java应用占一个进程（jvm的内存模型的资源也在这个进程中） ，一个进程占一个cpu ， 所以老师所说的多核cpu缓存，每个cpu有自己的缓存 ，AB两个线程在不同的cpu上操作不太理解 ， 一个应用的AB两个线程是不是应该处在同个cpu上面 ？？？<br><br>2. 如果按照老师所说不同线程在不同cpu上运行 ， 是不是有个叫并行和并发的概念 。 单个cpu的时候多线程实际上是模拟并发的并行，实际上cpu只能一次执行一个线程，两个线程交替执行。 而到了多核中，可以真正的将两个线程AB同时分给cpu1 .cpu2同时执行，称之为并发？？<br><br>3. 我感觉老师第二点原子性中也有包含可见性问题，由于时间片到了， 当把资源读到自己的工作线程中时，由于不可见性，以为自己是最新的导致值不准确，这个也对应了第一个问题 ， 两个线程是否在同个进程内共享资源<br><br>问题有点多 ， 可能自己的理解有偏差 ，希望老师指正<br></div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">进程和线程的关系，你可以看看操作系统原理。进程不占有CPU。操作系统会把CPU分配给线程。分到CPU的线程就能执行。<br>并行，是同一时刻，两个线程都在执行。并发，是同一时刻，只有一个执行，但是一个时间段内，两个线程都执行了。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/c5/7a/7da3cbe2.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">cfreedomc</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">5</span></a></div>
                            </div>
                            <div class="bd comment-content">今天主要学习了并发编程中三种类型的问题<br>1.缓存导致的可见性问题<br>2.线程切换导致的原子性问题<br>3.编译优化带来的有序性问题<br>也是让我认识到我们编程其实和医生看病一样，项目就是病人，当你给病人开药时，药的好处不必多说，更重要的是对于药的副作用有个清晰的认识才是一个好的医生<br><br>最后从这节课后，遇到并发问题，我也可以系统的通过将问题分类到是以上哪种或者哪几种问题去解决问题<br><br>如今天的课后题目，在java中 Long类型是64位的，在32位的系统中，Cpu指令要进行多次操作，无法保证原子性</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/dc/90/ff657ff2.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">小呆</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">4</span></a></div>
                            </div>
                            <div class="bd comment-content">Count那个应该是1到20000之间吧，而不是10000到20000之间吧？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">什么时候会是1呢？</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">diexue798</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">4</span></a></div>
                            </div>
                            <div class="bd comment-content">好好学习，不是很了解spring线程安全，springmvc线程安全这里,如果有成员变量，就算是数据共享了，就不安全了么，那么注入的servie怎么又是安全的，还有加不加锁的集合如果是局部变量是不是也都安全，那什么时候用线程安全的加了锁的集合呢？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">spring 默认创建的是单例，多线程共享这个单例，自然就存在并发问题了。service是不是安全，要看是不是单例，如果是单例，也会有问题。当然，你也可以写线程安全的service。局部变量都安全。有共享就要使用线程安全的集合。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/e2/f8/6e5da436.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Gavin</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">4</span></a></div>
                            </div>
                            <div class="bd comment-content">NIO和并发有什么关系呢？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">建议网上搜索 “闲话高并发的那些神话,看京东架构师如何把它拉下神坛”，这个里面的内容应该能解决你的困惑。这个题目是是京东小编加的，原来的题目是 闲话高并发。我怎么知道这么多？！</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaELZPnUAiajaR5C25EDLWeJURggyiaOP5GGPe2qlwpQcm5e3ybib8OsP4tvddFDLVRSNNGL5I3SFPJHsA/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">null</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">3</span></a></div>
                            </div>
                            <div class="bd comment-content">看完文章来刷评论，看到阿根一世的童鞋问题，确实是这样，锁🔒都还没有释放，线程B根本获取不到对象，所以线程A创建的对象是完整的，线程B后续获取的对象也是初始化完成的对象。<br>然后回去再看了一遍那一小段，当我看到线程B竞争锁资源失败后被阻塞，我就更肯定，应该是文章描述有误。<br>当再往下看文章，发现后面有说：“一切都很完美，无懈可击”。soga，这是描述我们自己觉得正常的场景。<br>接着文章下面分析异常的原因，但是没提到线程B在哪停下来，因此我们的思维还是停留在前面那一段，线程A和线程B都过了第一个判空语句，来了竞争锁 syncronized 这，所以有阿根一世同样的疑问。建议老师调整一下，在分析异常原因时，说明一下在哪个语句时发生了线程切换，这样童鞋们也更好理解。<br><br>😂这理解有偏差，属于可见性问题，是我们大脑缓存了之前的描述，导致了异常的理解😂</div>
                            <span class="time">2019-03-31</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">知音啊😂😂😂<br></p>
                                <p class="reply-time">2019-04-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/27/1d/1cb36854.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">小辉辉</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">3</span></a></div>
                            </div>
                            <div class="bd comment-content">看完这一篇，觉得我之前看的《Java高并发编程详解》和《深入理解Java虚拟机》两本书没白看，至少看懂老师说的问题了，看完评论（差不多半小时），原来高手都在评论区😀 😀 😀 </div>
                            <span class="time">2019-03-14</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/2d/47/7c3baa15.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Reloaded</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">3</span></a></div>
                            </div>
                            <div class="bd comment-content">对于创建单例那个问题，可以在声明变量的时候加上 volatile 关键字，有两个作用,一是可以禁止指令重排序(源头三)，二是保证了程序的可见性(源头一)</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erbuZDOPPYrdmf7fRb0jmkB0LyT0wBdvxlKjVoZ4G8V1XAPPVcZCcryBH806b2EpoqTbEIujCF6IQ/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Geek_df1217</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">3</span></a></div>
                            </div>
                            <div class="bd comment-content">volatile关键字可以禁止指令重排序，可以解决大部分人的疑惑</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/f6/a6/3221900b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">terry</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">3</span></a></div>
                            </div>
                            <div class="bd comment-content">讲得真是通俗易懂，尤其是结合三张图的说明，真的是足够清晰了。之前都是靠去记一些概念和规则，老师讲的是通过原理结合图例去说明，并讲述了背景以及硬件和操作系统设计的原因，以及产生的新问题，这回理解了。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eo5vic8QksE4b8ricXxKrEWJyOX9pwiadhk3kvHYoLXoKRTWvbFCxibFTbExNQWDG4nvNfpic9t1umibKww/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">江楠大盗</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">3</span></a></div>
                            </div>
                            <div class="bd comment-content">双重检查那个，A进到第二个if里，刚把引用给变量，这时B到第一个if，一看不是null，直接就返回了，不会去抢锁，拿到一个没有初始化完成的引用，导致后续异常。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/zZiamzXOang0L4iaXa37k1wM8TqU6cqkQNCKZ9XUBWXPFndtvkXrtRGMLPur4zIvoYMHaicIU1fFibKTZJo8Lmnxug/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">suynan</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content"><br>并发编程的场景中的三个bug源头：可见性、原子性、有序性<br>1.可见性：多核系统每个cpu自带高速缓存，彼此间不交换信息（列子：两个线程对同一份实列变量count累加，结果可能不等于累加之和，因为线程将内存值载入各自的缓存中，之后的累加操作基于缓存值进行，并不是累加一次往内存回写一次）<br>2.原子性：cpu分时操作导致线程的切换，（列子：AB两个线程同时进行count+=1，由于+=操作是3步指令①从内存加载②+1操作③回写到主内，线程A对其进行了①②操作后，切换到B线程，B线程进行了①②③，这时内存值是1，然后再切到A执行③操作，这时的值也还是1，PS:这貌似也存在可见性的问题）<br> 3.有序性：指令的重排序（列子：单列模式的双重检测，new指令也是3步操作，①分内存②初始化③赋值给引用变量，可能会发生①③②的重排序，这时候如果又有操作系统的分时操作的加持，导致A操作①③后挂起，时间片被分配给了B线程，而B线程甚至都不需要进行锁的获取，因为此时instance已经不等于null了，但是此时的instance可能未初始化）</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">很透彻！</p>
                                <p class="reply-time">2019-03-08</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">linus</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">关于文章开始说的单cpu的情况，如果也是非原子行操作，也会出现并发问题？<br></div>
                            <span class="time">2019-03-06</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">会出的，单核也有并发问题。</p>
                                <p class="reply-time">2019-03-06</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">幻想</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">良心专栏呀。目前正准备组织小组成员学习该专栏，概念和背景都讲的非常清楚。老板让俺给一个技术规划，我列的其中一个，便是全组人员学习该专栏，并以小组分享的方式讲出来。</div>
                            <span class="time">2019-03-03</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">有你这样的读者，俺会更加努力地。</p>
                                <p class="reply-time">2019-03-03</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/00/c7/9fe483cd.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ok绷</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">最近在看设计模式，看到老师有说单例模式的双重检查锁模式有问题，但是没有具体解释，但是只是记下来了，今天终于明白了，感谢老师的讲解，受益匪浅。</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">你受益，是对我最大的鼓励<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/d8/0e/45f18710.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Wobum</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">哇，感觉讲的好通俗易懂啊，nice！</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">感谢夸奖啊<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/9c/aa/6f780187.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">言希</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">今天才意识到一直写的饿汉式单例是有安全问题的，以前对导致并发问题的根源模糊不清，今天学习完之后清晰很多，原来技术后面都是有逻辑的。<br><br>思考题:因为long和double是64位的，在32位机器上进行加减操作会分高位和低位进行在线程上下文切换的大环境下，可能会出现其他线程读到一更新了一半的值</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/48/1b/7de6e72e.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">牧童纪年</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">对于Jialin同学的volatile 语义的理解，我不太认可，volatile关键字 应该是no cached ，所以不会出现“强制重新把内存中的内容写入到自己的缓存” 这一说，都是写操作完事后，如果不发生任务切换，则直接将修改的最新的值刷新到内存中的把？@王老师，你说呢？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">volatile 语义下一期会讲。但是不会涉及具体如何实现的。如果大家感兴趣，可以参考《Java并发编程的艺术》</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/ef/9e/78420b67.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">0928</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">long和double类型的变量是64位，但是在32位JVM中，32位的JVM会将64位数据的读写操作分为2次32位的读写操作来进行，这就导致了long、double类型的变量在32位虚拟机中是非原子操作所以在并发时存在数据不一致的问题。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/1d/c8/4a67ef73.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">石磊</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">B没有拿到锁 B进入第一个if后直接返回了，因为B线程认为这个singleton已经不是null了，故不存在争夺锁资源。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/4f/7f/5dc11380.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">苏志辉</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">双重检锁是因为另外的线程在一个判空的地方拿到的还没进去锁那里，本人看法，不知道对不</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">对</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/f3/69/7039d03f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">书策稠浊</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">两次相加结果应该是10000到20000，两边都是闭区间。</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">目光如炬！是这样的</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/6e/6a/38a3fa8d.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">多拉格·five</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">2</span></a></div>
                            </div>
                            <div class="bd comment-content">老师我想问一下,既然优化后会出现问题,那么怎么修改能避免这种问题,还有怎么打印出来或者是怎么能看到优化后的路径</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">Java内存模型告诉你解决方案了，敬请期待。优化后的路径，可以看Java的字节码。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/fa/bc/a246831a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">冯治刚</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">对于嘎嘎的回答：volatile只解决可见性问题，不保证原子性问题，这句话有点疑问。volatile禁止指令重排，所以instance得初始化过程不会重排，也就不会存在拿到空内存地址的instance。这不就间接地解决了这个NPE问题了吗？虽然不保证原子性，但起码不会出现问题。所以我认为加volatile是没问题的。</div>
                            <span class="time">2019-04-23</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/5b/72/4f8a4297.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">阿May的海绵宝宝</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">线程启动时将内存中的值加载到缓存中，所有计算基于缓存中的值，例子中线程计算10000次加法，在这10000次循环中，随机时间会将当前计算结果写回内存，也会在缓存失效时，缓存重新从内存中加载count值，继续进行计算。还要注意的是缓存中的值是线性的不会忽大忽小。1.是这样理解吗？2.缓存什么情况下失效？3.如果运行过程中，如果重新从内存加载值到缓存中，不就可能造成count值非线性变化吗？</div>
                            <span class="time">2019-04-06</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">缓存失效的条件很复杂，不同cpu也不一样。即便跑的慢的把跑的快的数据覆盖了，暂时会下降，跑的慢的线程也会继续把count＋1，所以结果不会比10000小。<br></p>
                                <p class="reply-time">2019-04-23</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/f7/0a/067537fc.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">别皱眉</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">老师 <br>既然cpu将缓存写入内存的时机是不确定的 <br>假设共享变量没用volatile <br>那当缓存被写入内存时 会通知其他线程更新该值在缓存中的值吗？<br>还有就是其他线程会在随机时间内重新内存中的值吗？</div>
                            <span class="time">2019-03-16</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">非volatile 变量写内存，不会通知其他线程更新缓存中的值<br><br>其他线程，只有缓存失效才会重新去内存加载</p>
                                <p class="reply-time">2019-03-16</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/08/1c/ef15e661.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username"> 臣馟飞扬</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">JAVA内存模型中说的每个线程都有自己的工作内存，然后将共享变量从主存读到自己的工作内存中进行操作，操作完后再回写到主存中。假如线程A在将共享变量读到自己的工作内存后，发生CPU切换，线程B读共享变量并操作，操作完回写主存后，线程A继续操作并回写结果，导致可见性问题。那线程的工作内存到底指什么呢？如果是指CPU缓存的话，指的是多个线程共享同一块CPU缓存还是每个线程隔离一块呢？</div>
                            <span class="time">2019-03-09</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">我不知道很多人说的工作内存是啥，所以专栏就没提。我只能暂且认为是cpu缓存，或者问问有些书籍，网文的作者，工作内存究竟是啥<br></p>
                                <p class="reply-time">2019-03-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/7b/57/a9b04544.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">QQ怪</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">在32位的jvm上面进行加减过程中，是把64位分为2段32进行的，不是原子性操作，为了解决上面单例有序性问题，应该在声明单例对象上加上volatile关键字，能够防止指令重排</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">volatile关键字 不能解决原子性问题</p>
                                <p class="reply-time">2019-03-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/zZiamzXOang0L4iaXa37k1wM8TqU6cqkQNCKZ9XUBWXPFndtvkXrtRGMLPur4zIvoYMHaicIU1fFibKTZJo8Lmnxug/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">suynan</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">关于二少的问题：<br>二少<br>2019-03-08<br><br>关于双重锁的问题，如果线程进入Asynchronized块中以后，在即将执行第三步的时候，发生线程切换了，那么线程A拿到的锁会释放么？<br><br>我的看法：我觉得线程A的锁不会释放。因为编译后，会在synchronized语句结束处或者异常出口处插入指令monitorexit，而只有当jvm执行到这个指令，才会释放锁，显然时间片的切换不会导致锁的释放</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">多谢你的正确解答</p>
                                <p class="reply-time">2019-03-08</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/4e/60/be4992fd.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">gogo</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">在单核时代，线程 A 和线程 B 都是操作同一个 CPU 里面的缓存，所以线程 A 更新了变量 V 的值，那么线程 B 之后再访问变量 V，得到的一定是 V 的最新值（线程 A 写过的值）。<br><br>老师您好，这句话的意思是说单核cpu的情况下共享变量就相当于加了volatile关键字修饰了吗<br></div>
                            <span class="time">2019-03-02</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">我的意思是，单核情况下，不存在可见性问题。当然volatile关键字不仅仅有这个作用，你可以看下一篇文章。</p>
                                <p class="reply-time">2019-03-02</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/bc/eb/c22ef3a5.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Nevermore</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">因为long是64位的，对于一个32位的系统来说，只要是未被volatile修饰的变量，它的读写操作会被划分成两次32位操作进行的，也就是说只保证32位的原子性，也就是说当线程A写变量a的时候，当写完32位就释放锁，这个时候就存在锁竞争，如果锁被线程A竞争到则一切正常，如果被线程B竞争到，则对于线程B来说，他可能读到了线程A写的一半结果。</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">高手啊，这个锁不知道哪里来的？<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/0e/e8/5d2c3e08.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">何方妖孽</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">synchronized修饰的代码块里，会出现线程切换么？我理解的synchronized作用就是同步执行，不会线程切换，请作者给我解答下。</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">在同步块里，线程也可能被操作系统剥夺cpu的使用权，但是其他线程此时是拿不到锁，所以其他线程不会执行同步块的代码<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/08/37/a98500d9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">我用黑人我自信</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">在单核时代，线程 A 和线程 B 都是操作同一个 CPU 里面的缓存，所以线程 A 更新了变量 V 的值，那么线程 B 之后再访问变量 V，得到的一定是 V 的最新值（线程 A 写过的值）。<br><br>请问老师这意思是说单核cpu没有并发问题吗</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">单核也有并发问题，产生并发问题的原因有很多，单核上不用考虑可见性问题<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/5f/83/bb728e53.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">jimforcode</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">老师有两个疑问<br>1.io 操作(等待或者其他读写操作)的时候系统会出让cpu 资源让其执行其他任务，这里说明io 操作不会占用cpu 资源吗？<br>2.io 完成，会执行其他的io 操作这里io 操作都是顺序排队执行的吗？同一时间不会出现两个io 操作，可以这样理解吗？<br>谢谢</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">io操作不占用cpu<br>是不是有两个io同时执行，要看是什么io设备<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/06/62/898449d3.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">... ...</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">多核系统，线程操作哪个cpu的缓存是不是完全随机的还是有一定规律性的？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">你可以将一个线程绑定到一颗CPU上。否则看操作系统心情。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/01/2b/2bc4f35b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">crudBoy</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">你好，我想问一些问题，一个cup同一时刻只能运行一个线程吗？ 之所以想问这个是因为你文章中的代码示例。 你的代码里两个线程的分别调用了add10K这个方法。 如果说一个cup同一时刻可以运行多个线程，那你的配图我觉得有一定的误导，因为你并不知道那两个线程是否真的是跑在两个cup上。 如果说一个cpu同一时刻只能跑一个线程的话你这个配图没问题。  所以，我的问题很简单，cpu是不是同一时刻只能跑一个线程，如果有多个线程同时被启动且机器是单核那么其他的线程是会暂时被挂起还是交叉执行？ 谢谢</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">多核，可以同时跑多个线程。<br>单核，同一时刻只有一个执行，其他线程会挂起。但是你在一个时间段上看，他们是交叉执行的</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/54/44/4e541a86.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Junzi</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">总结<br>可见性：读取缓存导致，如 cpu缓存，缓存的时差性导致数据对其他线程不可见；<br>原子性：线程切换导致，如 count += 1 一条执行语句实际是由三个原子指令组成；<br>有序性：编译优化导致，如 双重检查创建单例，编译优化产生指令重排。<br><br>问题<br>long型是8个字节，需要64位进行存储。在32为机器上只能分两次读取到cpu寄存器中，执行两条指令。因此在32位机器上对long型的计算不是原子性的，如果有线程切换会导致并发问题</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/ee/27/53c78632.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ljp</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">“我们假设线程 A 和线程 B 同时开始执行，那么第一次都会将 count=0 读到各自的 CPU 缓存里，执行完 count+=1 之后，各自 CPU 缓存里的值都是 1，同时写入内存后，我们会发现内存中是 1，而不是我们期望的 2。之后由于各自的 CPU 缓存里都有了 count 的值，两个线程都是基于 CPU 缓存里的 count 值来计算，所以导致最终 count 的值都是小于 20000 的。”这段话最后一句说，cpu缓存里都有了count的值，之后计算就用cpu缓存里的值来计算，那什么时候刷回内存呢？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">看CPU心情。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/ac/ef/8336bd81.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">crazypokerk</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">想请问下老师，那个new对象的操作，是针对所有情况都会进行优化的吗?还是说取决于操作系统或其他什么因素呢？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">主要取决于编译器，至于解释器、CPU理论上也有优化。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://thirdwx.qlogo.cn/mmopen/vi_32/21uTMWr7bx5qMibp2hwmGvLbYuj5Aic2dqD3futlNo25eDGDt4t7zzN9cdnj7cVGwTot1U4AyADfWUpqjq1SicgWQ/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">奔跑的小孩</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">循环接近还是接近2亿啊，不过确实有误差，我跑的值199991022</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">可能你的机器太好了</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/e4/3a/ca44a563.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">浪尘</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">学习到了，以前没有想过简单的count++ 这样的操作都会被cpu拆分成几个指令而形成并发问题；<br>但是如果这么简单的操作都有并发问题，那我们写的多线程程序中对各个共享变量的操作都应该存在类似的问题，应用程序是怎样通过简单的类似于加锁的操作就避免了这种问题的，期待从下面的课程中得到一个答案；<br>总结：导致并发问题的起因主要是缓存可见性，线程切换导致的原子操作问题和编译器优化导致的有序性变化。归结就是多步骤的计算过程在空间或者时间上的混乱（空间上缓存和内存中数据变化没有及时同步，时间上各个线程操作时间线相互穿插，或者编译器优化导致的实际操作过程变化）<br></div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">总结的很到位</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/03/f7/3a493bec.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">老杨同志</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">点赞 @xx鼠<br>另外，回答@阿根一世提出的问题。<br>出问题的情况并不需要A线程释放锁，只要instance指向内存M，instance==null就不成立了。<br><br> if (instance == null) {<br>      //条件不成立跳过中间部分。<br> }<br>//线程B拿到未初始化完成的对象，进行操作，会出问题，不太了解，感觉应该是不可预知的问题。比如那片内存上之前有其他内容<br> </div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">你这么想是对的</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/3d/51/9723276c.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">邋遢的流浪剑客</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">1</span></a></div>
                            </div>
                            <div class="bd comment-content">老师讲的真好，结合之前看并发编程相关书籍的内容理解更深刻了</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">感谢认可，我会继续努力！</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/79/f7/c5f34f59.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">song</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，您好，为什么例子的运行结果一定不会大于10000？<br>难道一定不会出现这样的情况：线程1先执行，线程2后执行，线程2把缓存中较小的count写入内存，然后线程1从内存中读出较小的count开始后续计算，最终导致结果小于10000.<br>期待您的回复</div>
                            <span class="time">2019-05-18</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/0d/bd/57ab02f5.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Sam</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">深入浅出，没有操作系统这样基础课程的小白也能理解，赞！</div>
                            <span class="time">2019-05-18</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/e1/d2/42ad2c87.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">今夜秋风和</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，您好，有几个问题想请教下您<br>1.cpu在执行一个原子性的指令的时，完成后是才会写cpu缓存，cpu缓存什么时候会写主存?<br>2cpu和内存的交互具体是怎么同步的?假如内存更新了，另一个线程在另一个cpu上执行，cpu怎么加拿大值的更新过程？<br>3编译器能为我们优化到什么程度，人为的意义的思考执行过程，怎么确定编译器的执行过程?</div>
                            <span class="time">2019-05-17</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">如果指令有写操作r=1，执行完就会写主存，但是其他核C2里可能已经缓存了r=0，r=1并不会立刻反映到C2里，通俗地说是C2看不到r的变化。</p>
                                <p class="reply-time">2019-05-18</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/17/65/52/07c09c7f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">josancpp</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">xx鼠说，改为final欠妥，改为final，整个程序都没啥意义了。</div>
                            <span class="time">2019-05-16</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/17/65/52/07c09c7f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">josancpp</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">Blithe回答的很好，但出现的错误不是NPE错误，而不是使用了未初始化的空间</div>
                            <span class="time">2019-05-16</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/86/59/e8f58a2a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">LAMBO</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">Java操作的不是内存里的数据吗？<br>也会去操作CPU或IO设备里的数据？<br>又颠覆了我对Java的认识。<br>可有Java读取内存、CPU、IO设备的讲解文章分享？谢谢大神</div>
                            <span class="time">2019-05-16</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Marvin</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">@jialin，看了你的留言，有一点没有明白，线程A改变完缓存中变量得值，会强制刷新到内存，如果这时切换到线程B，B已经读取过该变量的值到cpu缓存中，此时应该做+1操作，这时也会强制在内存中读取一下该变量么？</div>
                            <span class="time">2019-05-15</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/41/f4/5df17eff.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">新的起点，新的开始^_^</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，那单核CPU的机器运行两个线程A和B，都是对共享变量初始值count==0，逻辑count+=1的操作，如果A先执行，根据可见性，B在执行操作前肯定读取到了count=1了，那执行完B之后，最后的值肯定会是2，但根据后面的原子性，A和B都会分别执行CPU指令1，2，3；在线程切换时也可能会出问题，所以我认为单核两线程的机器执行上面的逻辑，最后的结果可能是1也可能是2的对吗？请见谅，我的理解能力太差，对线程这块太欠缺。</div>
                            <span class="time">2019-05-10</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的，单核CPU没有可见性问题，但是有原子性问题。</p>
                                <p class="reply-time">2019-05-12</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/41/f4/5df17eff.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">新的起点，新的开始^_^</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">王老师，CPU执行完A线程java语言表达式的某个CPU指令后，发生线程切换，去执行B线程，会导致释放锁吗</div>
                            <span class="time">2019-05-09</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">不会</p>
                                <p class="reply-time">2019-05-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/41/f4/5df17eff.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">新的起点，新的开始^_^</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">王老师你好，我这里有个疑问<br>count += 1，至少需要三条 CPU 指令。<br>CPU能保证的原子性是CPU指令级别的，在源头二那个例子中，在单核上运行两个线程，最后count的结果可能是1对吧，然后我又想到了源头1的上面的描述：<br>在单核时代，所有的线程都是在一颗 CPU 上执行，A线程对内存中count的操作对于B线程来说是可见的，所以不会出问题，但是您在讲CPU指令原子性问题的时候这不是出问题了吗<br><br></div>
                            <span class="time">2019-05-09</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">单核不存在可见性问题，原子性问题还是有的</p>
                                <p class="reply-time">2019-05-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTK6Nic6V6iawbbIF1RRbRlwNmC0Cmt3LlQRAiaiayCibpplSDPXticVyOp97CEypEuQm2Iib7ZYCjrrlIgWQ/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">奔跑的蜗牛</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">有个疑问就是A线程未完成instance指向内存，是否会释放锁呢？如果没释放，B线程就无法进入同步块中</div>
                            <span class="time">2019-05-09</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/fe/46/0b160701.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">唯爱龚迪</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content"> private static int x = 0, y = 0;<br>    private static int a = 0, b =0;<br><br>    public static void main(String[] args) throws InterruptedException {<br>        int i = 0;<br>        for(;;) {<br>            i++;<br>            x = 0; y = 0;<br>            a = 0; b = 0;<br>            CountDownLatch latch = new CountDownLatch(1);<br><br>            Thread one = new Thread(() -&gt; {<br>                try {<br>                    latch.await();<br>                } catch (InterruptedException e) {<br>                }<br>                a = 1;<br>                x = b;<br>            });<br><br>            Thread other = new Thread(() -&gt; {<br>                try {<br>                    latch.await();<br>                } catch (InterruptedException e) {<br>                }<br>                b = 1;<br>                y = a;<br>            });<br>            one.start();other.start();<br>            latch.countDown();<br>            one.join();other.join();<br><br>            String result = "第" + i + "次 (" + x + "," + y + "）";<br>            if(x == 0 &amp;&amp; y == 0) {<br>                System.err.println(result);<br>                break;<br>            } else {<br>                System.out.println(result);<br>            }<br>        }<br>    }<br><br>这里附加上一个演示指令重排序的例子。</div>
                            <span class="time">2019-05-08</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/7c/0f/58142505.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">姚毛毛</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">19995<br>19996<br>19997<br>19998<br>19999<br>20000<br>count:20000<br><br>为什么同样的代码，我得到的是顺序的结果？</div>
                            <span class="time">2019-05-06</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/19/36/95246ba9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">steventang</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">课后思考讨论的场景应该都是 共享的临界区域吧</div>
                            <span class="time">2019-04-29</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/63/12/af32e9d4.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">melon-skin</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">那么缓存造成的可见性问题是多核cpu并行造成的 单核cpu 的并发是不会有缓存可见性的问题的？</div>
                            <span class="time">2019-04-26</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">单核cpu没有缓存可见性的问题</p>
                                <p class="reply-time">2019-04-29</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/17/0c/09/e73e3709.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Geek_Bowen</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，我想请教一下。线程切换让出CPU是不是就意味着锁也释放了？</div>
                            <span class="time">2019-04-26</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">锁不会释放</p>
                                <p class="reply-time">2019-04-26</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/47/1b/64262861.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">胡廷</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">public class Singleton<br>{<br>    private volatile static Singleton singleton = null;<br>    private Singleton()  {    }<br>    public static Singleton getInstance()   {<br>        if (singleton== null)  {<br>            synchronized (Singleton.class) {<br>                if (singleton== null)  {<br>                    singleton= new Singleton();<br>                }<br>            }<br>        }<br>        return singleton;<br>    }<br>}<br><br>对于 singleton= new Singleton() ，实际是三个操作<br>1、分配一块内存 M<br>2、在内存 M 上初始化 Singleton 对象<br>3、然后 M 的地址赋值给 instance 变量<br><br>那是不是说使用 volatile 修饰 Singleton 后就保证<br>一定按 1 --&gt; 2 --&gt; 3 的顺序来执行？<br>那么岂不是 volatile 保证了这个操作的原子性？<br>但是volatile应该是不能保证操作的原子性的啊？<br><br>求解！<br><br></div>
                            <span class="time">2019-04-26</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/2a/54/c9990105.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">bro.</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">请问对于双重检查的优化,使用静态内部类的方法吗?</div>
                            <span class="time">2019-04-25</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/5d/60/38ea52c5.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Bright丶</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">对于文中例子最后结果出现9000小于10000这种结果，我想线程之间的执行大概是这样子的：线程A和线程B首先都读取到count的值为0，这时候线程A得到执行权，假如线程A将count的值操作到了5000后切换到线程B，线程B寄存器保存的count的值还是0，执行操作后为1再切换到线程A，线程A读取到的是1，前面5000次操作都白费了，操作后可能为2，并且线程A将2读取寄存器了，线程B读取到2，操作5000次后再切换为线程A，线程A操作后可能变成了3，线程B的5000次操作又白费了，以此类推，白费力气了很多次，最后结果可能小于10000</div>
                            <span class="time">2019-04-24</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/fb/6a/be4956a3.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">劉小强</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">@嘎嘎   将对象设置成volatile，在new 的时候可以防止指令重排 也就不会在第一个判断空的时候返回没有初始化的对象了啊  在加上锁肯定是没问题的啊   你说 其实也不能完全解决问题。volatile只是保证可见性，并不保证原子性。没有太理解</div>
                            <span class="time">2019-04-22</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/7d/7d/d1a1ea86.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">哈哈哈</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">看了留言，还是觉得奇怪，<br>第一synchronized不是可以保证可见性吗？<br>第二就是锁都没释放，其他线程不应该是等待吗？<br>第三synchronized不是会保证操作的原子性吗</div>
                            <span class="time">2019-04-22</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">大家说的是set方法同步了，get方法没同步</p>
                                <p class="reply-time">2019-04-22</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/59/12/2034b163.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">五花肉小生</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">宝令老师，“编译器为了优化性能，有时候会改变程序中语句的先后顺序” 这个东西的标准是什么呢？可以举个例子讲一下吗？</div>
                            <span class="time">2019-04-20</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">int a=12；//1<br>省略100万行；<br>int b=1+a；//2<br>这个时候就会把1,2放到一起</p>
                                <p class="reply-time">2019-04-20</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/66/82/c2acd57e.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">蔡呆呆</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">文中所指的CPU缓存只是L1，L2和L3，cpu寄存器是缓存之外的部分？同时volitale对L1，L2和L3生效？</div>
                            <span class="time">2019-04-19</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/5c/00/5b933841.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">🐳 蓓</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">操作数据库是读写操作<br>读入excel文件是IO操作？</div>
                            <span class="time">2019-04-18</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83eribUNj9ylC04DQdaM42AD0pLsVficcyTS3GdVBdibpnDrPSAo4ohNmBzRmiavOLuibCEj8wru0ibIJOZ1A/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">轩辕豆豆</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，我总结一下，如果有问题帮忙指点一下<br>1.可见性：两个线程将变量加载到不同cpu缓存中进行计算操作，这时cpu缓存中的变量不算是同一个值。<br>2.原子性：多线程调用方法时，每个线程不会将方法跑完 会有交叉现象。<br>3.有序性：代码顺序可能在编译后不会按照预先顺序执行。</div>
                            <span class="time">2019-04-18</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">👍<br></p>
                                <p class="reply-time">2019-04-30</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/0b/f1/042df911.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">qzm</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">在eclipse中单步无法复现双重检查导致返回为null的情况；同时开了1000个线程去执行也没有发生这种情况？不知道如何复现。另外大家对于在IDEA多线程debug是否很无语，在这方面eclipse的体验是否比IDEA好很多？</div>
                            <span class="time">2019-04-17</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/ae/00/025f37e7.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">xuery</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">long是64位的，在32位机器上是分高32位和低32位存储的，所以long的加减不是一个原子操作，会产生并发问题</div>
                            <span class="time">2019-04-17</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">liian2019</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">单例还是通过内部类方式实现比较可靠</div>
                            <span class="time">2019-04-16</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">liian2019</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">引用summer_Day的留言，我也觉得程序代码没有执行结束，为什么可以退出synchronized，是什么原因引起的？</div>
                            <span class="time">2019-04-16</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ycfHH</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">关于32 位的机器上对 long 型变量进行加减操作存在并发隐患<br>这个问题看到评论区说加volatile可以解决，完全不明白。原子性的问题咋就能用volatile关键字解决了呢？感觉long类型加volatile单纯是因为可见性吧。有序性感觉也没啥关系吧，高32位和低32位分开执行顺序即使错开也没什么关系。蒙圈了.....<br>望老师解答</div>
                            <span class="time">2019-04-16</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">单纯的赋值操作，说volatile具备原子性也不错，看语境吧，不做口舌之争</p>
                                <p class="reply-time">2019-04-16</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/d7/7e/f0f50f1d.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">panli004</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">flag，读完这一节，更加清楚的明白了双重检查锁声明instance实例为什么要加上volatile关键字了，static volatile Singleton instance = null了，禁止缓存优化。long上8字节64位，32位机器是4字节。故long在32位机器上一个字节是存储不下来的，故需要2次cpu读取指令，故会发生诡异问题。</div>
                            <span class="time">2019-04-16</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/af/8e/077dcde8.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">帝都牛人</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">看了这么多同学对老师问题的解析，被惊到了。留言区都是如此的高手，相比之下我太弱了，没二话，努力！</div>
                            <span class="time">2019-04-12</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI45zO9GOMqulTerqVQGSCdX8lwAeLTvrq2vVCANMQlm0cg9UtsNvShzEoVo32ff99UaaSCb17FqQ/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Geek_92f7ea</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">看到一些同学说volatile可以禁止指令重排序，那么这个关键字应该加在哪里呢？它又是禁止的哪一部分的指令重排序的呢？<br>为什么把volatile加在了instance上，就可以解决了下面的getInstance()方法的问题？<br>看到这篇文章有这么一点疑惑，请各位指教一下</div>
                            <span class="time">2019-04-11</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/LPnuO9GleKEwso2rSbibmbEwn49hnGl9qTQDBv2xLOOWOflQsc9oVEEuZgNBt7TrqRKvk8CX7Tc8iakhEicBCCfFg/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">盛权_vinc</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，请问一下，本例中的锁是不是只要执行了=将内存地址赋给变量就马上释放了，就不管初始化完成没有？初始化的指令由其他地方完成？还是说锁释放就仅仅紧跟着赋值语句，如果不是的话是不是应该等初始化完再释放锁，其他线程才获得锁之后对变量进行操作？</div>
                            <span class="time">2019-04-11</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">锁会在初始化之后才释放，但是有可能在初始化之前发生线程切换</p>
                                <p class="reply-time">2019-04-12</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLjrPm3HE2KwDa5zGK5N77KZwJEnPU5lgVhKuZicvQ1nL2iad92uetnCmdgIIxeCdu8lhoQ0w5uWEHA/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Geek_9621ee</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">关于双重检查锁，synchronized 块中的代码时为啥会发生线程切换呢，如果发生线程切换怎么保证原子性呢？</div>
                            <span class="time">2019-04-10</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">线程切换和原子性没必然联系，os想什么时候切就什么时候切<br></p>
                                <p class="reply-time">2019-04-10</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLjrPm3HE2KwDa5zGK5N77KZwJEnPU5lgVhKuZicvQ1nL2iad92uetnCmdgIIxeCdu8lhoQ0w5uWEHA/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Geek_9621ee</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">关于双重检查锁，为什么在执行synchronized 块中的代码时会发生CPU切换，</div>
                            <span class="time">2019-04-10</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">为什么不会？</p>
                                <p class="reply-time">2019-04-10</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/fa/e4/2eff2a09.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">kk</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">看了评论区已经找到答案了，这个时候B线程是执行第一次判空的步骤不需要获取锁</div>
                            <span class="time">2019-04-08</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/fa/e4/2eff2a09.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">kk</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">关于多线程下单例的问题，我有一点不懂，在A线程执行指令2的时候为什么会有可能切换到B线程，这个时候A线程不是加锁了吗而且没有释放，为什么B线程能被执行</div>
                            <span class="time">2019-04-08</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/5e/4e/85502e98.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">balance</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">可见性、原子性、有序性，多线并发问题往往都是综合性问题</div>
                            <span class="time">2019-04-06</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/5b/72/4f8a4297.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">阿May的海绵宝宝</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">1.有位同学说寄存器切换，是上下文切换的概念吧，切换的时候是把上个任务的寄存器和程序计数器状态保存，下次切换回来用的上次保存的状态。是否理解正确？<br>2.count循环执行过程中，什么时候缓存会从内存中重新加载变量？</div>
                            <span class="time">2019-04-06</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/5b/77/30a6e874.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Mr、Zeng</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，还是没懂这句话的意思，望解释的更具体点，编译程序优化指令执行次序，使得缓存能够得到更加合理地利用。</div>
                            <span class="time">2019-04-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">int a=1<br>int b=2<br>省略一万行<br><br>int c=a+b<br><br>最后一句放第三行就能让缓存更合理使用<br></p>
                                <p class="reply-time">2019-04-05</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/03/c9/9a9d82ab.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">涛哥</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">那个new操作符号的我反编译追踪过<br>1.会开启一块内存<br>2.返回两个引用，一个去赋值给变量，一个去执行构造函数</div>
                            <span class="time">2019-04-02</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/36/b3/c4a2f3fd.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">_light</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，我有两个问题，感谢😊<br>1：happens-before规则是规定了有序性还是可见性，还是说满足hb规则，可见性和有序性都会得到保证呢？有序性和可见性是不是只能通过hb规则保证呢？<br>2 ：unlock操作会将该cpu所有缓存都刷到主存，还是只将修改过的值刷到主存呢</div>
                            <span class="time">2019-04-02</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">有序性和可见性都能保证<br>不知道jvm怎么实现的，他做的事不仅仅是刷缓存，还要让其他核的缓存失效</p>
                                <p class="reply-time">2019-04-02</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/8a/f3/7c89d00e.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Presley</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，帮看一下理解对不对：“原子性：原子性由线程切换带来的”，我的理解：不切换行不？不行。不切换就是一条线程执行到底，其中耗时的部分可能导致其他任务完全处于阻塞状态，比如好像有些早期操作系统，任务获取cpu的模式是一个线程使用完了，才通知下一个，导致系统经常崩溃。后来都采用了竞争获取cpu的方式，不知道理解对不对？</div>
                            <span class="time">2019-04-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的，早期的操作系统单任务没有原子性问题。竞争很形象，不过我觉得用操作系统调度可能更准确</p>
                                <p class="reply-time">2019-04-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/b5/d4/3bd5b77b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">佑儿</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">重新温习了一遍，记得之前看过一篇文章，分析了java高级语言中的原子性操作：对于基本数据类型的变量读取赋值操作都是原子性的，对引用类型的变量读取和赋值操作也是原子性的，其他的操作均不具备原子性。因此new关键字不是原子性操作，当被解释器进行优化后，会出现cpu指令级的重新排序，导致并发问题。</div>
                            <span class="time">2019-04-01</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">侯大虎</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">对于 阿根一世 那个问题，明白了明白了，终于明白了。  评论区人才真多</div>
                            <span class="time">2019-03-30</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">侯大虎</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">为什么我还是没能理解 阿根一世的问题呢？synchronized保证原子，cpu虽然重排序，但是在一个原子里面执行，怎么会发生错误呢？</div>
                            <span class="time">2019-03-30</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/d3/94/36469860.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">度尘</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">用CAS更好一点吧，就不需要双重检查了</div>
                            <span class="time">2019-03-30</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/b2/b3/798a4bb2.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">帽子丨影</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">我理解的count问题最小值应该是2，A线程读到0加到9999，b线程读到0，加到1，a线程写到内存，此时内存为9999，b线程再写，此时内存为1，a、b线程再读到各自的缓冲，b线程加到10000，写到内存，a线程加到1，最后写到内存，最终结果为2。不知道理解的是不是有问题。</div>
                            <span class="time">2019-03-30</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">a线程写到内存，此时内存为9999，缓存里也会是9999，a的缓存一定是线性增长的，不会变小</p>
                                <p class="reply-time">2019-03-30</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/6d/d8/e52ec586.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">三叶</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">谢谢老师，我懂了</div>
                            <span class="time">2019-03-27</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/8b/ec/dc03f5ad.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">张天屹</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师请教个问题，对于第二点线程切换。当线程数&gt;cpu内核数目的时候就一定会发生切换，从而带来开销，那么比如一个n核的物理机，多大的并发数目m会遇到性能质变呢，这个有一般化的实践经验吗？</div>
                            <span class="time">2019-03-27</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/be/99/010f91a1.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">起风了</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">作者你好，在文中您说的创建一个对象是先 分配一个地址M，然后在地址M上实例化对象，在将M地址赋值给变量， 这种是正常的对象创建流程呢?，如果是的话，那 分配一个地址M，将M地址赋值给变量，然后在M地址上初始化对象 这种您在文中称之为优化，是指 指令重排 优化嘛？</div>
                            <span class="time">2019-03-27</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的<br></p>
                                <p class="reply-time">2019-03-27</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/6d/d8/e52ec586.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">三叶</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师我有个问题一直想不明白，a,b两线程执行count+1，循环100000次为什么是一个100000到200000的随机数？如果刚开始a,b两线程将count=0刷到各自的cpu缓存，基于各自cpu缓存里的count来计算count+1，那么循环万次那a,b线程里的count值都是100000</div>
                            <span class="time">2019-03-27</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">没有办法保证两个线程完全同时启动，同时两个线程不被中断，如果能做到结果很可能就是100000<br></p>
                                <p class="reply-time">2019-03-27</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/17/ba/4fb65853.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">李文斌</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">以前这块总是似懂非懂，看了老师的文章有种豁然开朗的感觉，尤其是单例模式的线程安全问题，看完之后明白了👍</div>
                            <span class="time">2019-03-26</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/38/be/4b946340.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">石头</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">Add自加的测试代码，出现少的原因很有可能是不具备原子性吧</div>
                            <span class="time">2019-03-26</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/0b/52/faf3d80e.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">子明</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">public class SingletonTest {<br><br>    private static SingletonTest instance;<br><br>    static SingletonTest getInstance() {<br>        if (instance == null) {<br>            synchronized (SingletonTest.class) {<br>                if (instance == null) {<br>                    instance = new SingletonTest();<br>                }<br>            }<br>        }<br>        return instance;<br>    }<br><br>    public static void main(String[] args) {<br>        // 计数器<br>        CountDownLatch countDownLatch = new CountDownLatch(1);<br>        for (int i = 0; i &lt; 100000; i++) {<br>            new Thread(() -&gt; {<br>                try {<br>                    // 阻塞线程<br>                    countDownLatch.await();<br>                } catch (InterruptedException e) {<br>                    e.printStackTrace();<br>                }<br>                SingletonTest.getInstance();<br>            }).start();<br>        }<br>        // 所有线程并发执行<br>        countDownLatch.countDown();<br>    }<br>}<br>这边写了一个类来模拟并发，没有出现空指针异常，是我模拟的有问题吗</div>
                            <span class="time">2019-03-26</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">概率太低，很难模拟。程序没有访问instance里的属性，永远都没有空指针</p>
                                <p class="reply-time">2019-03-27</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/fd/dd/baeda83e.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Monster!</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，请教一下嘎嘎所说的在类中写一个静态私有的内部类，然后通过公共的方法返回内部类中的instance，如果通过反射的话，是否可以获取这个方法，然后再new出一个新的Singleton呢？</div>
                            <span class="time">2019-03-25</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">可以，你这真是在写bug</p>
                                <p class="reply-time">2019-03-25</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/07/8c/51401220.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">小美</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">王老师，您好，文中累加，如果使用volatile生命，也没法保证最终结果是正确的。volatile是只能保证可见性和有序性，无法保证原子性吗？</div>
                            <span class="time">2019-03-23</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">无法保证<br></p>
                                <p class="reply-time">2019-03-23</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/bd/18/669ba15f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">兔2🐰🍃</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">专栏很有营养，持续学习中<br>双重检查锁的单例模式是面试中常见的一道题，听完老师讲解后知其所以然了。<br>public class Singleton {<br>  private static volatile Singleton instance;<br>  private Singleton(){}<br>  public static Singleton getInstance(){<br>    if (instance == null) {<br>      synchronized(Singleton.class) {<br>        if (instance == null)<br>          instance = new Singleton();<br>        }<br>    }<br>    return instance;<br>  }<br>}<br></div>
                            <span class="time">2019-03-22</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/81/44/a6cd7f8c.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">东坡先生</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">看了jialin的回答，我有个疑问，线程进入锁区后，线程应该走完才会去执行另一个线程吧，这时不应该会切换到另一个线程啊？</div>
                            <span class="time">2019-03-20</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">时间片用完，操作系统会强行切换的。</p>
                                <p class="reply-time">2019-03-20</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/02/f5/82659fc6.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">雷明正</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">对于双重判断，有个疑问，初始化的时候如果cpu时间片切换，但是此时变量还是处于线程工作内存中吧？并没有刷新到主内存吧？对于其他线程应该是不可见吧？如果是话，就不会出现异常了</div>
                            <span class="time">2019-03-18</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">也有可能刷，这个看cpu运行情况<br></p>
                                <p class="reply-time">2019-03-20</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/15/69/fc60d1f4.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">陈华应</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">long型变量是64位，在32位操作系统上对于long的加减操作是分高低位进行的，对于cpu来说一次操作的最小单位是一个操作指令，那么针对long的需要执行两次操作指令才能完成，出现了文中提到的线程切换带来的原子性问题，也就是并发情况下的隐患。学习过程中还是得边听、边停、边思考、最后总结。只是简单的听一遍，连留下印象都不算，转眼就忘。</div>
                            <span class="time">2019-03-18</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">初学者还是要多看几遍</p>
                                <p class="reply-time">2019-03-18</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/15/83/b21a3305.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">子曰</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">我怎么判断哪些指令是原子性的，哪些指令不是原子性的？</div>
                            <span class="time">2019-03-18</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">只有cpu指令是原子的，这个具体要看cpu的说明书了<br><br></p>
                                <p class="reply-time">2019-03-18</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/cd/ca/ddbd461a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">林健</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">非原子操作的执行路径示意图 里面：描述 count+=1，为 count +1=1，不应该是count = count+1嘛？</div>
                            <span class="time">2019-03-15</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">count=0,所以count+1=1</p>
                                <p class="reply-time">2019-03-15</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/54/19/95ff4cbd.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">格非</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，看完这篇文章收获很大，但是有一些疑问：<br>第一、一个程序在多个CPU系统上运行不是叫并行吗？Java中的一个多线程程序在多个CPU上是以并行方式运行，还是以并发方式运行呢？<br><br>第二、那个可见性问题，在单个CPU中是否存在呢？多核CPU由于都有各自缓存独立，所以对运行在不同CPU上的线程不可见，所以会导致一个线程更改了变量，对另外一个线程不可见的问题，这个好理解，但是不可见问题是否在单个CPU上的多线程是否存在呢？</div>
                            <span class="time">2019-03-14</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">个程序在多个CPU系统上运行是叫并行，并发的概念更大一些。<br><br>单核上不用考虑可见性问题</p>
                                <p class="reply-time">2019-03-14</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/60/da/d1d70e57.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">宇</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">64位变了在32位机器上存储cpu是不是就是分开两个存储，导致多线程中如果一个线程写完一个存储另外一个线程会介入导致存储值的错误，不知道说的对不</div>
                            <span class="time">2019-03-14</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是这样的<br></p>
                                <p class="reply-time">2019-03-14</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/a9/ca/2d8c4733.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">amourling</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">回复 嘎嘎的疑问，把变量设置为volatile的目的是防止重排序。</div>
                            <span class="time">2019-03-13</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">我这里看不到上下文，vo不仅仅有防止重排的作用，得综合在一起看<br></p>
                                <p class="reply-time">2019-03-13</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/97/1a/93bb213b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">李海明</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">我觉得有序性那个例子可能会让人产生歧义，关于有序性的说明太过于深。第一遍还以为是线程切换导致的问题，所以就没弄明白，回过头再来总结才看出来了</div>
                            <span class="time">2019-03-13</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">并发问题往往都是综合症，我实在想不出更简单的例子了<br><br></p>
                                <p class="reply-time">2019-03-13</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/05Wiazxo0OS5w9KdJ4OQAe3ezwaCXNY4DGoE0noPFzXtUhOGejgGKFR6WmMxr0KcEGOSahnjbOwxPSib88h0E6zA/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">linsen</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">对于volatile语义一直有个疑问，我们都知道volatile能保证可见性，但不能保证线程安全，但是如果都保证了可见性为什么还不能保证线程安全，线程A对变量的操作对线程B来说都是可见的，那不就保证了线程B操作的变量都是线程A更新之后的值，那不就线程安全了嘛？</div>
                            <span class="time">2019-03-13</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">带着这个问题往后看吧，原因太多了<br></p>
                                <p class="reply-time">2019-03-13</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/06/eb/b2c110b9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">夏夏夏夏夏</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">当A线程执行到//3，假如发生了重排序，有可能会将instance指向空对象，此时A线程还没有执行完，也没有释放锁。假如此时B线程执行到//1，则会判断出来instance！=null，所以会导致B线程获取的对象有问题。<br>public class Singleton {<br>  static Singleton instance;<br>  static Singleton getInstance(){<br>    if (instance == null) {                      //1<br>      synchronized(Singleton.class) {    //2<br>        if (instance == null)<br>          instance = new Singleton();      //3<br>        }<br>    }<br>    return instance;<br>  }<br>}<br></div>
                            <span class="time">2019-03-12</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">表述精准！</p>
                                <p class="reply-time">2019-03-12</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/e1/ca/a41422f6.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">橘子</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">对象是引用的当时，在双重检查里面，就算返回的是null，但是如果后面构造成功，这个引用对象还是正确的，只是当时使用的时候可能是null值？</div>
                            <span class="time">2019-03-10</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">会多创建一个对象出来，其他的没啥问题。</p>
                                <p class="reply-time">2019-03-10</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">侯大虎</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，线程内存，jvm内存，cpu缓存，内存 这是什么关系。。</div>
                            <span class="time">2019-03-10</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">内存、cpu缓存是物理存在的。jvm内存是软件存在的。线程内存你是指线程栈？</p>
                                <p class="reply-time">2019-03-10</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/10/c2/fec86652.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">子焜🌈</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">看了下一期的Happens-Before原则，jdk1.5以后的版本是不是在增加一个volatile对象在实例对象赋值后面，会不会对性能会更好一些，避免了单例对象读取时被volatile优化跳过cpu缓存？</div>
                            <span class="time">2019-03-10</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">没看明白。。。</p>
                                <p class="reply-time">2019-03-10</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/10/c2/fec86652.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">子焜🌈</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">对了，吧，对象再加volatile声明一下对象就可以解决对象的可见性了。</div>
                            <span class="time">2019-03-10</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/10/c2/fec86652.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">子焜🌈</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">getInstance() 方法并不完美。以前总是用这个方法，怎么才能完美呢？</div>
                            <span class="time">2019-03-10</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">spring注入啊，多简单。网上也有很多方案，我就不越俎代庖了。</p>
                                <p class="reply-time">2019-03-10</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/f2/86/6b226c3f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Hank_Yan</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">〔如果此时线程 B 也执行 getInstance() 方法，那么线程 B 会发现instance != null，所以直接返回 instance〕<br><br>这里加一句，线程B刚好执行到“第一个判断”，会发现  instance!=null ， 这样比较好，不然还是会有很多人误解是在执行第二个判断，然后问为什么锁没有释放，也能进行第二个判断。</div>
                            <span class="time">2019-03-10</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">你的建议很好！！！我这就改一下。</p>
                                <p class="reply-time">2019-03-10</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/ce/ab/e9d7811f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">shawn</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，我有个疑问，我们如何知道我们所写的代码优化后的执行顺序的。比如刚才单例那个例子，我们要知道优化后的顺序才能了解代码所存在的并发问题。</div>
                            <span class="time">2019-03-09</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">有一部分可以通过看汇编代码来看，但是CPU和解释器在运行期也会做一部分优化，所以很多时候都是看不到的，也很难重现。</p>
                                <p class="reply-time">2019-03-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erYNBIwAj3KdIXaXbeMBUjTMz31zAToHIJSdo7oQk8bfsibwViaLobVQ8miatwBlC5spLS9kVCzHMjUA/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">苏柏</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">对IO 的操作不占用CPU 吗，是谁做的，操作系统吗</div>
                            <span class="time">2019-03-09</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">硬件驱动做的。</p>
                                <p class="reply-time">2019-03-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/25/73/cbbbaef1.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">谢谢</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">针对嘎嘎所提的第4、5的现象，依据jsr标准是不应该出现，<br>1.A线程释放锁前不会出现B线程获得锁，2.A线程加锁后执行的所有指令都会优先于释放锁。<br>所以结论是A与B如果同时进入第一个分支，那么这个程序就没有问题，如果A线程先获取锁时，B线程未进入第一个分支，那么就可能出现因为指令重排序而先执行1、3指令后，发生线程切换，切换至A线程，此时A线程判断实例不为空进行返回，才会出错。不知是否这么理解，还请老师帮忙解答。</div>
                            <span class="time">2019-03-09</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">分析的很透彻！<br>A与B如果同时进入第一个分支，那么这个程序就没有问题，如果A线程先获取锁时，B线程未进入第一个分支，那么就可能出现问题。</p>
                                <p class="reply-time">2019-03-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/bc/a0/97c7679b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username"></span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">果然博大精深。我这菜鸟看起来很吃力</div>
                            <span class="time">2019-03-09</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">多看几遍，感觉吃力说明收获会很大<br></p>
                                <p class="reply-time">2019-03-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/52/37/13b4c8aa.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Vincent</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">long是64位，32位操作系统字长是32位，一次加减操作分成了高32位和低32位操作，两个cpu指令操作不能保证原子性</div>
                            <span class="time">2019-03-09</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">正确</p>
                                <p class="reply-time">2019-03-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/49/10/af49fa20.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">左耳朵狮子</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">线程切换示意图 为什么放到进程的段落？</div>
                            <span class="time">2019-03-09</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">放到下面有点晚，改成进程又可能引起误会，怕初学者以为现在的操作系统是做的进程切换，我再想想，你提的问题很好！</p>
                                <p class="reply-time">2019-03-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/08/1c/ef15e661.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username"> 臣馟飞扬</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">请教一下，可见性那个例子，我觉得就算是单核的CPU，也会出现可见性问题吧，因为按照jvm内存模型，每个线程对共享变量的操作都是在自己的工作内存里，操作完再回写到主存中，所以这跟CPU是单核还是多核应该没有关系吧？</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">工作内存的概念我没有找到真正的出处，所以不敢瞎讲。我在jsr133规范里没找到它，你知道他哪里来的吗？<br></p>
                                <p class="reply-time">2019-03-09</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/e2/a5/05276fad.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">马克</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">1、32位操作系统上执行long型数据的加减，会分高地位运算，存在并发问题。<br>2、双重检查，如果按照申请内存空间、创建对象、赋值的步骤执行，当A线程执行到步骤2时发生分片切换，B线程也会申请内存创建对象，就有可能产生两个对象的现象</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">应该不会创建两个对象，因为B线程拿不到锁。</p>
                                <p class="reply-time">2019-03-08</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/dc/9d/e20b37d7.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">马晓光</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">学习中</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">更新中</p>
                                <p class="reply-time">2019-03-08</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/df/03/6613bd63.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">姜浩远</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，您好！请问您在文中提到的“CPU缓存”和“CPU寄存器”是指的同一个东西么？</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">在这里是一回事<br></p>
                                <p class="reply-time">2019-03-08</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/zZiamzXOang0L4iaXa37k1wM8TqU6cqkQNCKZ9XUBWXPFndtvkXrtRGMLPur4zIvoYMHaicIU1fFibKTZJo8Lmnxug/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">suynan</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">第一个例子给的代码不能编译通过吧，calc()方法作为静态方法，不能直接return count，应该是return test.count</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">你说的对，评论区里有我完整代码<br></p>
                                <p class="reply-time">2019-03-08</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/04/45/0c474d47.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">二少</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">关于双重锁的问题，如果线程进入Asynchronized块中以后，在即将执行第三步的时候，发生线程切换了，那么线程A拿到的锁会释放么？</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">不会释放。后面会详细介绍什么时候锁会释放。</p>
                                <p class="reply-time">2019-03-08</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/03/11/f58c6278.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">闫循鸣</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">cpu缓存是将  count与  idx两个变量读入缓存  计算完结果后   再写入内存 ？ 这样的话结果不就是只会是10000与20000</div>
                            <span class="time">2019-03-08</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">cpu将缓存写入内存的时机是不确定的。除非你调用cpu相关指令强刷。</p>
                                <p class="reply-time">2019-03-08</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">空知</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师 问下原子性问题，查了下线程切换时候寄存器内容会被清空，那么由线程 B切换回线程 A时候执行 count + 1的count重新从内存加载吧，那不就是读取到了 线程 B回写的结果了？</div>
                            <span class="time">2019-03-07</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">切换的时候，寄存器的内容会保存到内存里，切换回来的时候，会从内存加载到寄存器。所以不会重新从内存加载</p>
                                <p class="reply-time">2019-03-08</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/e1/ca/a41422f6.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">橘子</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">第一个if可能存在逸出现象，发布了未构造好的instance，如果把第一个if条件去掉，应该是满足happen before的规则，所以是线程安全？</div>
                            <span class="time">2019-03-07</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的，就是慢</p>
                                <p class="reply-time">2019-03-07</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/4c/c0/f5b54f74.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">落落彩虹</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，我对“编译程序优化指令执行次序，使得缓存能够得到更加合理地利用”这个的因果关系没理解.</div>
                            <span class="time">2019-03-07</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">为了让寄存器、缓存里面的值，利用的更充分。<br>i=12；<br>j=23；<br>i++；<br>这个就会优化成<br>i=12；<br>i++；<br>j=23；<br>你看看能不能想明白吧</p>
                                <p class="reply-time">2019-03-07</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/14/f9/f5148008.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">贼像样</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">有个问题，双重验证单例的问题，在同步代码块中的代码执行途中，存在cpu切换吗？谢谢</div>
                            <span class="time">2019-03-07</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">存在<br></p>
                                <p class="reply-time">2019-03-07</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/70/51/eb68ec53.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Lugyedo</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">循环 10000 次 count+=1 操作如果改为循环 1 亿次，你会发现效果更明显，最终 count 的值接近 1 亿，而不是 2 亿。如果循环 10000 次，count 的值接近 20000，原因是两个线程不是同时启动的，有一个时差。<br><br>启动有时差和执行次数为什么会导致结果不一样？</div>
                            <span class="time">2019-03-06</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">重合比率越大，错的越离谱。若俩线程之间差十年，就没错误了<br></p>
                                <p class="reply-time">2019-03-06</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/63/a5/9254c76d.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">大海</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">任何操作系统都是这样吗？</div>
                            <span class="time">2019-03-06</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">主流操作系统都是这样<br></p>
                                <p class="reply-time">2019-03-06</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/2f/18/e437681f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">任洋爱吃肉</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师你好：文章中源头之一，缓存导致的可见性问题中 两个线程并发执行add10k()的示例里面。你提到A、B线程都是基于cpu缓存里的count值来计算。我的理解是A、B线程的count值一直都在缓存中，那么基于各自cpu中count缓存值来计算的话，那么最终的执行结果应该是10000才对啊，即在两个线程并行执行的最终结果都是10000，只是快慢完成而已，那为什么会是10000到20000之间的随机值呢？是线程cpu的缓存值在随机写入内存后会失效，下次执行指令时要重新从内存中读取吗？</div>
                            <span class="time">2019-03-06</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">你么有办法保证两个线程是完全同时执行的。cpu刷缓存也是随机的。最终导致结果不可推断。</p>
                                <p class="reply-time">2019-03-06</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/d1/17/356cc426.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">归心</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">王老师，我在运行第一个例子Test类时，count的值会出现20000这个值，而且几率很大。和老师文章中说的 count值都是小于20000的 结论是冲突的，希望老师能解释下，谢谢！</div>
                            <span class="time">2019-03-06</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">如果两个线程没有并行，执行完一个线程再执行下一个就会是20000</p>
                                <p class="reply-time">2019-03-06</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/2f/79/61794fe2.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">拨云见天</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">   非常喜欢老师的讲课风格，让我对学习并发编程产生了信心！对于双重锁的问题，个人结合第二节课【java内存模型】-管程中锁的规则，如果A线程被切换了，但是没有释放锁，那么对于B线程来说如果它在第一处 instance == null判断，由于没有获取锁，那么A线程对instance变量的操作对B线程来说是不可见的，所以第一处的instance==null会通过，然后执行同步块的代码，B线程由于获取不到锁就会被挂起；直到A线程释放锁，然后B线程在第二处instance==null时，由于管程中锁的规则A线程的释放锁操作Happens-BeforeB线程的获取锁操作，只有这时才是可见的，所以B线程在第二处才会返回instance，可能跟有些同学理解的不一样。老师我这样理解正确不？</div>
                            <span class="time">2019-03-06</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">b线程在没有获取锁之前，也有可能读到instance，所以才会有文中说的 bug，cpu什么时候刷缓存这个事不确定<br></p>
                                <p class="reply-time">2019-03-06</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/39/8e/eff81958.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">傲慢与偏见</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">好多说法之前略有耳闻，比如count+=1不是原子操作、以及编译优化改变指令执行顺序会存在线程安全问题等，之前只是那么一听，知道里头有文章，但并不理解前因后果，这次终于知道其实都是由于CPU指令才是面向线程切换的原子操作而导致的。</div>
                            <span class="time">2019-03-05</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的</p>
                                <p class="reply-time">2019-03-06</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/1b/2c/6b3c0911.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Hour</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">看到大家都在讨论阿根一世提的问题，觉得挺有意思，不过也有人没有理解阿根一世问题的点，所以顺理成章的被作者引导到NPE上了😂 <br><br>问题点在于，线程A，线程B都已经经过了第一层非空验证！<br><br>首先说下我的理解，第一：线程B访问时不会发生NPE；第二：会导致线程B再创建一个实例。<br><br>为什么线程B会再创建一个实例呢？答案是CPU的缓存导致了线程的不可见性，作者第一个例子已经提到过。线程B可能会从自己的CPU缓存拿出instance的时候，发现为空，所以又走了初始化的命令导致非单例。<br><br>那如何解决呢？通过valitale关键字修饰instance，这样线程A初始化后，释放锁，线程B拿到锁，二次非空验证时，知道了线程A已经对instance初始化了，就不再做任何操作，直接返回。保证真正实现单例。</div>
                            <span class="time">2019-03-05</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">问题在于，第一段我只是模拟错误的思维。第二段才指出问题。好多同学还是基于第一段来做推理。</p>
                                <p class="reply-time">2019-03-06</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/18/f6/2ff7bc7a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">轻歌赋</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">存在，因为long在JAVA中是64位的，在32位机器上面需要分别对两个32位进行操作，因此指令不是原子的。<br>但是对此有个问题，请问老师，32位机器对lomg类型操作了几条机器指令呢？有没有多种情况？<br>个人看法是起码6条，对每一个位都要读写和赋值，不知道老师怎么看呢</div>
                            <span class="time">2019-03-05</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">用汇编实现以下看看。万一有高级的指令呢</p>
                                <p class="reply-time">2019-03-05</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/f2/62/f873cd8f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">tongmin_tsai</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，volatile在这里的具体作用，能帮忙分析一下吗？是否他是让变量变成可见，那么如果按照这个程序执行，还是存在不一致的场景，只有加了锁，代码的执行才是20000，感谢老师解惑<br>public class VisiableTest2 {<br>    private volatile int count = 0;<br><br>    private void add() {<br>        int idx = 0;<br>        while (idx++ &lt; 10000) {<br>            count += 1;<br>        }<br>    }<br><br>    public static int calc() throws Exception {<br>        final VisiableTest2 test = new VisiableTest2();<br>        Thread th1 = new Thread(() -&gt; {<br>            test.add();<br>        });<br>        Thread th2 = new Thread(() -&gt; {<br>            test.add();<br>        });<br><br>        th1.start();<br>        th2.start();<br>        th1.join();<br>        th2.join();<br>        return test.count;<br>    }<br><br>    public static void main(String[] args) throws Exception {<br>        long c = calc();<br>        System.out.println(c);<br>    }<br>}</div>
                            <span class="time">2019-03-05</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">两个线程可以同时读到同一个值（这个违背任何HB），然后同时+=1，写入内存（这个违背任何HB）。结果是少加了一个1<br><br>只保证可见性，不保证原子性</p>
                                <p class="reply-time">2019-03-05</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/dd/8d/0396fabe.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">math</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">count等于一没试出来，但是小于10000试出来了。得到一个9821的值</div>
                            <span class="time">2019-03-05</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">理论上不会啊。你把完整代码贴出来，让大家帮忙测试一下。</p>
                                <p class="reply-time">2019-03-05</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/0a/b7/9cc85537.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ghost</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师您好，看了您的文章，受益颇深。<br>我有一个疑问。我将您的示例代码修改为：<br>//    private long count = 0;<br>    private volatile int count = 0;<br>结果依然是一个小于20000的随机值。<br>我理解的是：使用volatile 解决了可见性问题，使用int解决了原子性问题，但实际结果<br>却让人无法理解。<br>请老师帮忙解答下，谢谢。</div>
                            <span class="time">2019-03-05</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">没有解决原子性<br>count+=1这个不是原子性<br></p>
                                <p class="reply-time">2019-03-05</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/ee/d2/7024431c.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">探索无止境</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师您好，文中说到，编译程序优化指令执行次序，使得缓存能够得到更加合理地利用。这块不是很理解，可以举个例子吗？谢谢</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">为了让寄存器、缓存里面的值，利用的更充分。<br>i=12；<br>j=23；<br>i++；<br>这个就会优化成<br>i=12；<br>i++；<br>j=23；<br>你看看能不能想明白吧</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/09/98/b11c372b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">鸠翱</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">CPU缓存什么时候会写会内存（触发条件是什么）？<br>比如说CPU1的count的值加了1000之后，将值写回内存，然后第1001次操作又需要重新读取一次内存是这样子的嘛？</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">我也不知道，看CPU心情吧</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/0f/d6/30ae08a1.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">袁艺🌸15001179414</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">但是java是运行在虚拟机上的 和位数有关系吗</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">虚拟机和位数有关系，java程序没关系</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/57/8e/67990114.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">sheldon</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">阿根一世那个问题。<br>他应该想的是一个CPU的情况下，一个CPU情况下，锁还没释放，A线程还没结束，B线程就不会执行。<br>但是可以有多个CPU。<br>我这样理解，不知道对不对。</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">一个CPU情况下A线程还没结束，B线程也会执行。但是B线程不会执行到同步代码块里面。</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/a6/56/abb7bfe3.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">云儿-199412</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">评论区看的心潮澎湃</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">me too</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/1b/0d/9c3e2241.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">常银玲</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">感觉看留言，学习非常多，大家都非常棒！Java新手，很认真的敲了老师的例子，发现老师对与变量count前面加上static，程序才可以运行起来！</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">好认真，加油！</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/3d/19/9267792a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">尾戒</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师您好，关于双重检查那个例子，有点疑问：<br>线程A执行：<br>1.分配一块内存 M； <br>2.将 M 的地址赋值给 instance 变量；&lt;----这里发生切换，并且线程B可以读到线程A分配的地址<br>3.最后在内存 M 上初始化 Singleton 对象。<br><br>那么按照之前说的CPU缓存，CPU会把对象读取到自己的缓存里，针对这种初始化对象的情况CPU是怎么处理的？<br>因为不是很懂：<br>①如果这块的操作全在内存里，那么即便是像一些同学说的加上volatile关键字也不会解决这个问题的。<br>②如果这些操作是在CPU缓存里完成的，最后才写回真正的内存，那么就不存在线程B在外层判断时就读到了线程A分配的对象。<br><br>以上是我的疑惑，求解答~~</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">CPU什么时候写回内存，要看CPU的心情。所以假定它一成不定是不行的。你把CPU刷缓存想的随机一些就明白了</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/a0/88/a7a96ef1.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ZYY</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">编译程序优化指令执行次序，使得缓存能够得到更加合理地利用<br><br>这一句怎么理解呢？</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">为了让寄存器、缓存里面的值，利用的更充分。<br>i=12；<br>j=23；<br>i++；<br>这个就会优化成<br>i=12；<br>i++；<br>j=23；<br>你看看能不能想明白吧</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/ff/27/136d59c4.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">凌</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">令哥就是可以把复杂的问题给简单化，让大家听起来通俗易懂，看了看大家的评论，让我这个菜鸡也提升不少，高手在民间！</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">把简单的事情复杂化才是本事</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/64/be/12c37d15.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">CityAnimal</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">提个bug: Test中的calc()方法是staticd的，test变量是实例变量，编译时会报<br> non-static variable count cannot be referenced from a static context</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">public class Test {<br>    private int count = 0;<br>    private void add() {<br>        int idx = 0;<br>        while(idx++ &lt; 10000000) {<br>            count += 1;<br>        }<br>    }<br>    public static int calc() throws Exception {<br>        final Test test = new Test();<br>        Thread th1 = new Thread(()-&gt;{<br>            test.add();<br>        });<br>        Thread th2 = new Thread(()-&gt;{<br>            test.add();<br>        });<br><br>        th1.start();<br>        th2.start();<br>        th1.join();<br>        th2.join();<br>        return test.count;<br>    }<br><br>    public static void main(String[] args) throws Exception {<br>        long c =calc();<br>        System.out.println(c);<br>    }<br>}</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/fa/e0/0e80101a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">warning</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">大神说到，一个线程执行io操作，比如读操作，这时候cpu会让出时间片，我有个疑问，让出时间片后，还能继续读文件吗，求解答</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">读文件，是设备驱动干的事，cpu只管发命令。发完命令，就可以干别的事情了。</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/6e/3b/88f14e2a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">PK時頭髮不亂</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">太多计算机系统的知识了，可以开一门《深入理解计算机系统》的课程了，书太厚不好看，不好理解，老师帮我们拆解分析，我第一个到场^O^。</div>
                            <span class="time">2019-03-04</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">先让我消化消化</p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/83/b4/1c459a48.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ystwo</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">是不是可以把多核cpu比做分布式服务，因为synchronized修饰的代码块里只能在单服务才能起到锁的作用，也就是说两个cpu，a和b同时执行相同的代码，虽然有关键字，但是也无法限定计算机底层对cpu切片的切换，所以在切换后因为new的时候不是原子操作，才会出现因为多线程并发的原因导致有线程拿到空对象</div>
                            <span class="time">2019-03-03</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">太贴切了！jvm压根管不到os，os想做切换就切换<br></p>
                                <p class="reply-time">2019-03-04</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/f2/cd/a2ddcd33.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">dybai</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，双重检查的例子里，把第一个if去掉是不是就可以避免指令重排带来的问题了？根据JVM对synchronized的优化(使用轻量级锁)，这种场景下应该不会比volatile性能低吧。</div>
                            <span class="time">2019-03-03</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">可以避免，就是性能差。<br>一定比volatile性能低。</p>
                                <p class="reply-time">2019-03-03</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/bd/da/abb7bfe3.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">看不到de颜色</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">long类型站64位，所以32位操作系统无法做到原子性操作从而导致问题发生。<br>关于单例双检锁导致的问题，最终的解决方案是否可以采用内部类或枚举的方式解决呢？<br>还望老师可以百忙中解答疑惑，感谢~</div>
                            <span class="time">2019-03-03</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">可以，实现单例的方法有很多。</p>
                                <p class="reply-time">2019-03-03</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/85/03/eb460eda.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">高阳路人</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">java并发编程要用好有不少难度，作者讲的很好，系统学习一遍应该会有不错的效果。</div>
                            <span class="time">2019-03-03</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/4c/12/6d9493c3.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">rayjun</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">那是不是意味着并发编程中出现的问题，基本都是互斥这个问题没有解决好？</div>
                            <span class="time">2019-03-03</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">普遍认可的是互斥和同步这两方面的问题</p>
                                <p class="reply-time">2019-03-03</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/8c/1c/c564924f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">1</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">请问老师syn锁是什么时候释放的？</div>
                            <span class="time">2019-03-03</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">同步代码块结束的时候</p>
                                <p class="reply-time">2019-03-03</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEIvrwfqAuRkaK8Pl2apHKFZxd5mjnFhROMNcg5qXUT4AxE2ZTTia5Hg6pmFM1vozq3vZiagJoaJ4Pyg/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">zhangwei</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师好，双重检查锁有个问题希望老师解答下，说CPU从线程A切换到了线程B，线程B就看到了对象。是一定能看到呢还是可能看到？如果是一定能看到，是不是说CPU切换到其他线程后，线程A一定会把缓存刷新到内存呢？切换到其他线程之前会不会也刷新缓存到内存呢？谢谢！</div>
                            <span class="time">2019-03-02</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是可能看到，只有解锁后才是一定刷缓存</p>
                                <p class="reply-time">2019-03-03</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/d9/7a/7d3f792c.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">August</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">请问在双重锁检验的时候，编译器对new的优化，为什么要优化成先赋值再初始化呢？编译器优化出于什么目的这样优化呢？</div>
                            <span class="time">2019-03-02</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">这个我也没深入研究，猜测是更好地利用当前寄存器、缓存的值。</p>
                                <p class="reply-time">2019-03-02</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/48/bd/6c7d4230.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Tony Du</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">请问老师，同一个cpu上多个线程对同一共享变量的缓存是存在cpu同一个缓存上吗？如果是的，是不是可以理解为：单cpu的机器上的多线程编程不会有变量可见性问题？</div>
                            <span class="time">2019-03-02</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的，单核不存在可见性问题。</p>
                                <p class="reply-time">2019-03-02</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/ff/0a/12faa44e.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">晓杰</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">请问为什么双重锁的例子要对创建对象进行优化</div>
                            <span class="time">2019-03-02</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">这个要去问做Java编译器的那帮人，应该也是为了优化性能。</p>
                                <p class="reply-time">2019-03-02</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/d4/90/a1e06e28.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Colin</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师 看了其他评论关于双重检验那个还是有点疑惑，线程A还没初始化完毕，线程B怎么会拿到锁然后去判断instance是否为空呢？</div>
                            <span class="time">2019-03-02</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">双重检查创建单例的异常执行路径 这个图上面的文字再理解一下。我们假设线程 A 先执行 getInstance() 方法... ...切换到了线程 B 上；如果此时线程 B 也执行getInstance() 方法。这个时候线程B执行getInstance() 方法的第一行，第一行代码是直接判断instance是否为空，<br><br></p>
                                <p class="reply-time">2019-03-02</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/5b/0a/e02b6a0f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">褚超</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">这个问题对64bit也试用吧，至少规范是这么多的。或许有些jvm的实现在64bit机器上可能可以保证是原子的，但是不能假定。</div>
                            <span class="time">2019-03-02</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的，多重保护总没有错。</p>
                                <p class="reply-time">2019-03-02</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/79/9e/cb58102f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">心安。</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，您好。我有一个问题，就是在文章最前面说的cpu会访问内存甚至IO，这里的IO指的的硬盘之类的持久化设备吗？</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的，主要是硬盘和网卡<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/96/63/fdbf75eb.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">捞鱼的搬砖奇</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">为什么说排队读文件会造成CPU使用率上升，文章中说的IO是DMA吗。CPU交给DMA就不管切换到别的线程了。</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">io不止是dma，cpu把任务交给dma，cpu可以干别的工作，这样cpu利用率就上来了。否则cpu只能死等io,利用率就低t了<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/2b/58/11c05ccb.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">One day</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">理解老师的内存模型，JVM处理以及CPU指令等等是否需要把计算机原理这部分全都都弄清楚才能更好理解并发呢。</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">弄清楚和并发相关的就行，当然知道的越多越好。高级语言本来就要屏蔽那些底层细节，没屏蔽好，是语言没做好。可是语言就是没做好，怎么办呢，只能去钻底层了。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">一眼万年</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">双重检查问题，synchronized是作用在class下，表示所有class实例都被同步锁了，为什么还存在另一线程进入代码模块？老师请教下</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">我写的有问题，是第一个线程进入同步块之后，另一个线程才开始调用<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">腾达</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">getInstance() 单实例是否有问题，要是能有字节码级别或汇编级别的debug调试过程演示就更好了。否则都是在空谈</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的，要是能理解cpu微指令就更好了<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/e4/3a/ca44a563.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">浪尘</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">现在感觉我写的代码平常在正常运行都是我运气好</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">所以有必要拜拜图灵，冯诺依曼</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/64/86/6b593cb9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Zach_</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">评论区很活跃，受益匪浅!<br><br>老师专栏让我想起了这句话:<br><br>活生生地学，学地活生生!</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">大家这么活跃，高兴啊！<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/c0/b5/bd64c1ac.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Home</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师您好，根据您前面提到的，多核cpu可能导致缓存的可见性问题会导致多线程安全问题，这里我有几点不太明白，单核是没有可见性问题了吗？第二，单核cpu是线程安全的吗？如果不是，那是违背了你这里提出的哪几个因素？</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">单核没有可见性问题，单核cpu有线程安全问题，会有原子性问题，有序性问题<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/0a/5d/72b34189.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">深海</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">那老师，关于有序性的正确写法是不是将这这双重判断方式改为同步方法？因为以前写单例的情况，findBugs 会提示改为同步方法，当时没有意识，现在想想好像是这个道理</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">线程安全的单例模式有很多方案，你可以在网上搜一下，都很容易理解。只有双重检查不太容易理解，所以就拿出来讲了<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/64/86/6b593cb9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Zach_</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">想请老师或者评论区的朋友们 对下面这个方法做出优缺点评价。<br><br>class Singleton3 {<br>	<br>	private static Singleton3 instance;<br><br>	/**<br>	 * 0. 对 getInstance()方法添加 synchronized 关键字 后有两个问题：<br>	 * <br>	 * 1. 此时，缓存导致的可见性问题、线程切换带来的原子性、编译优化带来的有序性问题  都不存在了吧？<br>	 * <br>	 * 2. 但是，这个getInstance()方法上添加 synchronized 关键字，是不是太过度使用锁了？<br>	 * <br>	 * 3. 想请老师或者评论区的朋友们 对这个方法做出优缺点评价。<br>	 * <br>	 * @return instance<br>	 */<br>	public static synchronized Singleton3 getInstance() {<br>		<br>		if (null == instance) {<br>			instance = new Singleton3();<br>		}<br>		return instance;<br>	}<br>	<br>}<br><br></div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">正确，就是性能不好，有点过度<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/3c/02/d9a8c8ce.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">k2b_dll</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">各位大神回复的volitail关键字修饰instance的时候，是指哪些指令不会被重排序呢？</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">volitail变量读写之前的代码，不会重排到之后<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/42/65/f444ea39.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">grandcool</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，源头二中，将count加载到cpu寄存器这步，对于单核来说，寄存器是给每个线程分配独立空间吗？</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">寄存器是共用的，线程切换的时候，会把寄存器保存下来，这个在操作系统里叫上下文。你可以理解为每个线程有自己的寄存器<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/64/86/6b593cb9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Zach_</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师的比喻太贴切了:<br><br> 教好学生，饿死师父!<br><br>给宝令老师点赞!</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">回头，要是有人能帮我写两篇就好了<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/64/86/6b593cb9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Zach_</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">计数问题 光加volitile只能保证可见性 还不能保证原子性，所以多线程下要保证安全性，还是要对加操作加锁的吧？</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">是的，要加锁，要么使用原子类<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/96/a4/c2063ce1.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">东海罗杰</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">评论区人才辈出，我一愣神的功夫已经失去答题的机会了</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">下次要快<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/e9/42/26c386ae.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">loading...</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">看了留言，大神好多啊，我要虚心学习了。</div>
                            <span class="time">2019-03-01</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">话说高手都在留言区，不在民间啊！<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/14/06/62/898449d3.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">... ...</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">你好老师，文中两个线程的例子应该是原子性导致的吧！在count++上同步每次直一样。如果是可见性导致的话，那么在count上加上volatile就可以解决问题啊！<br>还有个小问题，实例变量不能直接用于静态方法中吧！</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">可见性是问题之一，还有原子性问题<br>示例代码只用来描述问题，考虑到手机屏幕小，所以省略了很多细节<br></p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/10/bb/9a389192.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">DemonLee</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">return test.count;</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJUzv6S9wroydkGP6m3OsQ8QuI4jAibv21tNkm7KVGPffJibj8Y29yIdKl4qkDGd3iaGJCSGVarfxoibQ/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">狂战俄洛伊</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">就是那个计数的问题，我使用了volitile关键字来修饰count变量，可是还是得不到20000，为什么呢？volitile不就是保证共享变量的可见性的么</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">两个线程同时读到1，同时增加，同时写入，内存中是2，而不是3。保证可见性，也没用。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/04/ef/fea0fdbd.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">小黄</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">你在示例中已经说了count = count + 1存在可见性问题，那么说明普通的加法 都存在可见性问题，除非是原子加法。对吗？</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/00/24/88d354e5.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">无为</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">线程A加锁后，执行加锁中的代码的时候，会发生线程切换么？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">会，操作系统不会让它执行100年的</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/e2/86/90041355.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">一塌糊涂</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">形象生动</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/01/e7/091804b7.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">长眉_张永</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">应该是A在锁后 创建对象  分配空间   此时cpu切换了到B了，才出现的问题不为null了</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/01/e7/091804b7.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">长眉_张永</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">讲的真带劲，好好消化！对于实际中双重检查的问题，真出现了，可能就当作灵异事件了</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">jmdxy</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">对于阿根一世同学的问题 文章里面已经说清楚了， new关键字 是先赋值，对象的地址。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/a0/da/4f50f1b2.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Knight²º¹⁸</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">其实阿根一屁世同学已经理解老师所讲的，但是对Synchronize的规则没有理解。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/01/37/58650ade.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">高源</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">long数据类型64位在32位机器上会有并发产生，原因会产生原子性性问题，老师对底层原理讲的非常透彻，明天原理后就知道如何用哪种方法解决问题了</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">沸羊羊</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">回复：【黄朋飞】文中的cache指的是cpu cache，cup-cache又分为L1-cache、L2-cache、L2-cache。建议补补组成原理再来看这个专栏</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/ee/27/53c78632.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ljp</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">volatile有个疑问，加了这个关键字的变量，每次都先从缓存中同步到内存中才能使用，如果做同步之后，缓存的值被更改了，那当时同步的数据将变成脏数据。既然volatile无法保证数据的正确性，就只剩禁用指令重排的效果了，如果为了禁用指令重排，那为什么每次还从cpu的缓存取值呢？这样岂不是增加了复杂度吗？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">看完下一期的内容，你再想想，看能不能想通</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/91/71/0b16655d.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">小麦</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">课后思考：32位机器的CPU一次最多只能处理32位数据，在Java中的long类型是64位的，所以对long类型的数据进行加减操作就需要多条指令（反正不止一条指令），那么就产生原子性的问题。<br>我的问题：处理器用缓存一致性协议来保证cache的一致，那么为什么还会存在缓存不一致的问题呢？缓存一致性协议到底是怎么起作用的？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">缓存一致性协议，可以简单理解为CPU给你提供了一个指令，这个指令可以做到缓存一致性。但是如果你不调用这个指令，那CPU就不负责了。我们的程序，默认编译器都不会调用这个指令的。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">17702158422</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">@Gavin 说下我的理解，nio属于网络通信框架，相对于socket而言支持更多的并发连接，同一时刻多个线程同时如果对同一块内存变量操作就会引发线程不安全问题</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/ee/27/53c78632.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">ljp</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">阅读第一个例子时，有个疑问：count的值0，从内存同步到cpu的缓存，执行+1指令后，在不加volatile的情况下，何时再从缓存写回内存呢？<br>我的理解是，执行+1指令后，立刻将缓存的值同步到内存，让出cpu缓存的空间。在下次+1的时候，重新将内存的值同步回缓存做+1操作。当多个线程同时从cpu缓存同步数据回内存时，由于各个cpu缓存的数据不一定相等，所以会导致内存值的不确定性。再次执行count+1时，重新从内存同步回缓存的值，将会以最近一次从缓存同步回内存的值为准，这样一直恶性循环下去，最终的结果会与预期差异很大。</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">什么时候写回，要看CPU的心情</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/0e/6c/3f179ea8.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">翟毅</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">双重检查的有疑问，重点应该不是线程切换，而是第一个线程对成员变量赋值，第二个线程可能看不到</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/UqX0llmKiabBHa8PvOUA4QMv3qmx4MfYBjia2gNvJ4X291CttHNtIjLeTyeh9ze0umJHLpQwxL8YTSiaagnMt4OAQ/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">carryyou_sister</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">我也像上面那位老铁那样有9000多的值，求解释啊</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/03/4f/7f3f912d.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">吴鹏</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，怎么模拟编译优化带来的问题？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">我还没模拟出来，不过你可以通过看字节码来确认问题。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/50/da/ed4803cb.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">CCC</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">针对这个问题：「对于双重锁检查那个例子，我有一个疑问，A如果没有完成实例的初始化，锁应该不会释放的，B是拿不到锁的，怎么还会出问题呢？」<br><br>其实线程B判断instance != null不是在synchronized块里，而是在第一个instance != null的地方，这地方是没锁的。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/03/11/f58c6278.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">闫循鸣</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老王   催更了。。。。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/64/86/6b593cb9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Zach_</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师讲地很深刻，<br><br>我回答一下 @阿根一世:<br><br>线程A还没到synchronized（Singleton.vlass）就被切换，也就是说，线程A刚进入instance方法就被切换了； 然后线程B开始执行，线程B进入getInstance方法，进入synchronized(Singleton.class) 拿到锁， 又按排序后new对应的CPU指令执行了前两条，1.先开辟一段内侧M，2.把M的地址赋给instance,第3步还没执行，线程B被切换了，但是线程B是拿着锁的，线程A是还没拿到锁的，但是线程A也不需要锁了，原因是什么呢？就是因为线程A的第一次 if(null == instance)<br>是false啊， 所以直接返回了，因此才会在多线程getInstance时第一次初始化还没完成的时候就可能会报诡异的空指针。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/64/86/6b593cb9.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Zach_</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">另外，像getInstance方法， synchronized lock 这些锁能保证多线程下抢占被这些修饰的方法或者变量时， 当前获取到锁的线程 能不被切换吗？  <br><br>或者， 假设只有线程A和线程B， A抢到锁后，cpu调度可能被切换到线程B吗？ 如果切换到线程B是不是就是继续等待线程A释放当前锁？ 然后时间片执行完之后，又切回到线程A, 线程A继续正常执行？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">不能保证不被切换。线程B要执行synchronized{}里面的内容，需要获得锁，这个时候是获取不到的，因为被线程A占着呢。所以线程B会被挂起。</p>
                                <p class="reply-time">2019-03-01</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/16/d6/97f6af3f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">boyLi</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，使用静态内部类的方式实现单例模式，会不会出现线程安全的问题呢？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">不会，JVM能保证。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ergYdR0OZhfht5f0BhZ6tdzvMcnZqLGshwj2mj3nuuKIfqBXYxOicxHUR97dVqNapHZztibEF2AXImw/132" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">better789</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">Null是值不是对象，判断为Null直接返回对象，而不会去获取锁。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">新世界</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">大家有疑问的是，锁没有释放，为啥线程2能够获取，其实线程二无法获取锁的，第一个instance==null线程2直接返回了一个未创建完成的对象，当使用这个对象时就有问题了</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/15/37/4f/d580236f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">SupeRyin·詩</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">双锁检查那个线程B拿到未初始化的实例，老师的意思是：线程A，B不在同时进行，当线程A执行完将M的地址赋值给instance变量时，CPU切换时间片，恰好线程B执行了，并且拿到了CPU的使用权，在第一个条件判断的后就拿到了未初始化的instance。</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/f8/ba/14e05601.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">约书亚</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">在 32 位的机器上对 long 型变量进行加减操作是否存在并发问题？<br>简单说64位的long在32位上操作是有问题的，但据称某些cpu指令集的实现是可以解决这个问题的？<br>另外指令重排，除了发生在编译期，是否由于cpu流水线机制的指令buffer，也可能出现在运行时的乱序执行情况呢？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">会的，但是为了大家理解，没有深入。JVM执行引擎也有优化。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/03/f7/3a493bec.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">老杨同志</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">课后思考题：<br>      32位操作系统对long进行加减操作存在并发隐患，我的答案是会存在并发隐患。<br>long是64位的，在加载到缓存的时候，需要两个缓存行存储。如果线程A操作完低32位，时间片耗尽，切换另外一个线程，操作了两个缓存行，然后线程A进行执行，结果可能会不可预期。感觉编译器会通过同步机制把对两个缓存行的操作变成原子操作。</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">目前编译器还没这么智能</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">wwj</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">对内存模型理解不深刻、实际上书和资料都不少、但感觉都一样、只说结果、没有细致分析、希望这次有所收获</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">下一期讲内存模型</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/ea/05/c0d8014d.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">刘章周</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">看到很多同学对双重检锁有疑问，我解释下:线程B指的是对第一个if语句进行判断，因为instance有地址，所以直接返回。</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">多谢！</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/0f/58/15/56f4e62a.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">antz</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">【我们把一个或者多个操作在 CPU 执行的过程中不被中断的特性称为原子性】，我的理解这里的原子性可能是cpu在时间片内的原子性操作，而不能是synchronized里的原子性操作，这个理解有问题吗？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">没有问题，原子性在不同的语境里是不同的。在这里，原子性属于微观世界，像原子一样，不可分割。宏观的多条语句也会有原子性的问题。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/10/78/c7/083a3a0b.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">新世界</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">long类型是8字节，64位，cpu执行时，由于是32位CPU，long类型CPU指令至少两次执行，就会有原子性问题</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">正解</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/13/f3/69/7039d03f.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">书策稠浊</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">循环一亿次为什么是接近一亿？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">因为是真的并发。如果循环10次，可能都没有并发。</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/da/ec/779c1a78.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">往事随风，顺其自然</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">双重检测加锁是在内部第二次，如果线程Ｂ在第一次检测是否为空，此时A线程部分初始化，但是对象也不为空，Ｂ线程获取到的对象没有完全初始化的对象，使用会有问题</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">YES</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/16/07/bf/120e10ea.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">刘凯</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">双重检查讲的是对的，我看错了，判断是否为null不需要锁就能判断</div>
                            <span class="time">2019-02-28</span>
                            
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/11/2b/45/e8f64725.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">Smile</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">老师，缓冲导致原子性问题，也可以理解，不同的cpu缓冲无法得到及时更新，同步，那，不同cpu是什么时候将自己的缓冲同步到内存，其他cpu是什么时候更新缓冲的呢？</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">这个真难倒我了，CPU有专门的指令，这方面我还没研究过</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li><li data-v-87ffcada="" class="comment-item">
                        <img src="https://static001.geekbang.org/account/avatar/00/12/6e/6a/38a3fa8d.jpg" class="avatar">
                        <div class="info">
                            <div class="hd"><span class="username">多拉格·five</span>
                                <div class="control"><!----> <a href="javascript:;" class="btn-praise"><i class="iconfont"></i> <span class="like-count">0</span></a></div>
                            </div>
                            <div class="bd comment-content">在32位系统对32位变量读写是原子操作,但是long是64,所以是非原子操作,简单的说，在32位操作系统上，对64位的数据的读写是分两步的，一步取前32位数据，一步取后32位数据，通过这两步操作来实现对64位数据的读写.</div>
                            <span class="time">2019-02-28</span>
                            <div class="reply">
                                <div class="reply-hd"><i class="iconfont"></i> <span class="reply-username">作者回复</span></div>
                                <p class="reply-content">正解</p>
                                <p class="reply-time">2019-02-28</p></div>
                        </div>
                    </li></ul>
            </div>
        </div> <!----> <!----></div>
</div>
<link rel="dns-prefetch" href="//cdn.mathjax.org">
<script type="text/x-mathjax-config">MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        tex2jax: {
          inlineMath: [['$','$'], ['\\(','\\)']],
          displayMath: [ ["$$","$$"] ],
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'a']
        }
      });
      MathJax.Hub.Register.MessageHook("End Process", function (message) {
        var eve = new Event('mathjaxfini')
        window.dispatchEvent(eve)
      })




</script>

</body>